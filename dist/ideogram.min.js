function ModelAdapter(t){this._model=t,this._class="ModelAdapter"}function ModelNoBandsAdapter(t){ModelAdapter.call(this,t),this._class="ModelNoBandsAdapter"}function Layout(t,o){this._config=t,this._ideo=o,this._description=new PloidyDescription(t.ploidyDesc),this._translate=void 0,this._tickSize=8,this._isRotated=!1}function HorizontalLayout(t,o){Layout.call(this,t,o),this._class="HorizontalLayout",this._margin={left:25,top:30}}function VerticalLayout(t,o){Layout.call(this,t,o),this._class="VerticalLayout",this._margin={top:30,left:15}}function PairedLayout(t,o){Layout.call(this,t,o),this._class="PairedLayout",this._margin={left:30}}function SmallLayout(t,o){Layout.call(this,t,o),this._class="SmallLayout",this._margin={left:36.5,top:10}}function Ploidy(t){this._config=t}function Color(t){this._config=t,this._description=new PloidyDescription(t.ploidyDesc)}function PloidyDescription(t){this._description=this._normilize(t)}function Chromosome(t,o,e){this._adapter=t,this._model=this._adapter.getModel(),this._config=o,this._ideo=e,this._color=new Color(this._config),this._bumpCoefficient=5}function TelocentricChromosome(t,o,e){Chromosome.call(this,t,o,e),this._class="TelocentricChromosome",this._pArmOffset=4}function MetacentricChromosome(t,o,e){Chromosome.call(this,t,o,e),this._class="MetacentricChromosome"}function naturalSort(t,o){var e,n,r=/(^([+\-]?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?(?=\D|\s|$))|^0x[\da-fA-F]+$|\d+)/g,i=/^\s+|\s+$/g,s=/\s+/g,a=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,c=/^0x[0-9a-f]+$/i,l=/^0/,h=function(t){return(naturalSort.insensitive&&(""+t).toLowerCase()||""+t).replace(i,"")},u=h(t),p=h(o),m=u.replace(r,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),d=p.replace(r,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),f=parseInt(u.match(c),16)||1!==m.length&&Date.parse(u),g=parseInt(p.match(c),16)||f&&p.match(a)&&Date.parse(p)||null,y=function(t,o){return(!t.match(l)||1==o)&&parseFloat(t)||t.replace(s," ").replace(i,"")||0};if(g){if(f<g)return-1;if(f>g)return 1}for(var b=0,_=m.length,v=d.length,x=Math.max(_,v);b<x;b++){if(e=y(m[b]||"",_),n=y(d[b]||"",v),isNaN(e)!==isNaN(n))return isNaN(e)?1:-1;if(/[^\x00-\x80]/.test(e+n)&&e.localeCompare){var L=e.localeCompare(n);return L/Math.abs(L)}if(e<n)return-1;if(e>n)return 1}}ModelAdapter.getInstance=function(t){return t.bands?new ModelAdapter(t):new ModelNoBandsAdapter(t)},ModelAdapter.prototype.getModel=function(){return this._model},ModelAdapter.prototype.getCssClass=function(){return""},ModelNoBandsAdapter.prototype=Object.create(ModelAdapter.prototype),ModelNoBandsAdapter.prototype.getModel=function(){return this._model.bands=[],this._model.width>1&&this._model.bands.push({name:"p",px:{start:0,stop:this._model.width,width:this._model.width}}),this._model},ModelNoBandsAdapter.prototype.getCssClass=function(){return"noBands"},Layout.getInstance=function(t,o){return"perspective"in t&&"comparative"==t.perspective?new PairedLayout(t,o):"rows"in t&&t.rows>1?new SmallLayout(t,o):"vertical"===t.orientation?new VerticalLayout(t,o):"horizontal"===t.orientation?new HorizontalLayout(t,o):new VerticalLayout(t,o)},Layout.prototype._getYScale=function(){return 20/this._config.chrWidth},Layout.prototype.rotateBack=function(t,o,e,n){throw new Error(this._class+"#rotateBack not implemented")},Layout.prototype.rotateForward=function(t,o,e,n){throw new Error(this._class+"#rotateForward not implemented")},Layout.prototype.rotate=function(t,o,e){var n=d3.selectAll("g.chromosome").filter(function(t,o){return this!==e});this._isRotated?(this._isRotated=!1,this.rotateBack(t,o,e,function(){n.style("display",null),d3.selectAll(".chrSetLabel, .chrLabel").style("display",null)})):(this._isRotated=!0,n.style("display","none"),d3.selectAll(".chrSetLabel, .chrLabel").style("display","none"),this.rotateForward(t,o,e))},Layout.prototype._getAdditionalOffset=function(){return(this._config.annotationHeight||0)*(this._config.numAnnotTracks||1)},Layout.prototype._getChromosomeSetSize=function(t){var o=this._description.getSetSize(t);return o*this._config.chrWidth*2+(this._config.ploidy>1?20:0)},Layout.prototype.getMargin=function(){return this._margin},Layout.prototype.getHeight=function(t){throw new Error(this._class+"#getHeight not implemented")},Layout.prototype.getChromosomeBandTickY1=function(t){throw new Error(this._class+"#getChromosomeBandTickY1 not implemented")},Layout.prototype.getChromosomeBandTickY2=function(t){throw new Error(this._class+"#getChromosomeBandTickY2 not implemented")},Layout.prototype.getChromosomeBandLabelTranslate=function(t,o){throw new Error(this._class+"#getChromosomeBandLabelTranslate not implemented")},Layout.prototype.getChromosomeBandLabelAnchor=function(t){throw new Error(this._class+"#getChromosomeBandLabelAnchor not implemented")},Layout.prototype.getChromosomeLabelXPosition=function(t){throw new Error(this._class+"#getChromosomeLabelXPosition not implemented")},Layout.prototype.getChromosomeLabelYPosition=function(t){throw new Error(this._class+"#getChromosomeLabelYPosition not implemented")},Layout.prototype.getChromosomeSetLabelYPosition=function(t){throw new Error(this._class+"#getChromosomeSetLabelYPosition not implemented")},Layout.prototype.getChromosomeSetLabelXPosition=function(t){throw new Error(this._class+"#getChromosomeSetLabelXPosition not implemented")},Layout.prototype.getChromosomeSetLabelTranslate=function(){throw new Error(this._class+"#getChromosomeSetLabelTranslate not implemented")},Layout.prototype.getChromosomeSetTranslate=function(t){throw new Error(this._class+"#getChromosomeSetTranslate not implemented")},Layout.prototype.getChromosomeSetYTranslate=function(t){throw new Error(this._class+"#getChromosomeSetYTranslate not implemented")},HorizontalLayout.prototype=Object.create(Layout.prototype),HorizontalLayout.prototype.rotateForward=function(t,o,e,n){var r=20,i=d3.select("#_ideogram").node().getBoundingClientRect(),s=e.getBoundingClientRect(),a=i.height/(s.width+r/2)*.97,c=this._getYScale(),l=(o+1)*(2*this._config.chrWidth*c),h="rotate(90) translate("+r+", -"+l+") scale("+a+", "+c+")";d3.select(e.parentNode).transition().attr("transform",h).on("end",n)},HorizontalLayout.prototype.rotateBack=function(t,o,e,n){var r=this.getChromosomeSetTranslate(t);d3.select(e.parentNode).transition().attr("transform",r).on("end",n)},HorizontalLayout.prototype.getHeight=function(t){var o=this.getChromosomeSetYTranslate(this._config.chromosomes[t].length-1),e=this._getChromosomeSetSize(this._config.chromosomes[t].length-1);return o+=e,o+2*this._getAdditionalOffset()},HorizontalLayout.prototype.getChromosomeBandLabelAnchor=function(t){return null},HorizontalLayout.prototype.getChromosomeBandTickY1=function(t){return 2},HorizontalLayout.prototype.getChromosomeBandTickY2=function(t){return 10},HorizontalLayout.prototype.getChromosomeBandLabelTranslate=function(t){var o=this._ideo.round(-this._tickSize+t.px.start+t.px.width/2),e=-10;return{x:o,y:e,translate:"translate("+o+","+e+")"}},HorizontalLayout.prototype.getChromosomeSetLabelTranslate=function(){return null},HorizontalLayout.prototype.getChromosomeSetTranslate=function(t){return"translate("+this._margin.left+", "+this.getChromosomeSetYTranslate(t)+")"},HorizontalLayout.prototype.getChromosomeSetYTranslate=function(t){var o=this._getAdditionalOffset();if(!this._config.ploidyDesc)return 30*t+this._config.chrWidth+2*o+o*t;if(!this._translate){this._translate=[1];for(var e=1;e<this._config.ploidyDesc.length;e++)this._translate[e]=this._translate[e-1]+this._getChromosomeSetSize(e-1)}return this._translate[t]},HorizontalLayout.prototype.getChromosomeSetLabelXPosition=function(t){return-20},HorizontalLayout.prototype.getChromosomeSetLabelYPosition=function(t){return this._description.getSetSize(t)*this._config.chrWidth},HorizontalLayout.prototype.getChromosomeLabelXPosition=function(t){return-8},HorizontalLayout.prototype.getChromosomeLabelYPosition=function(t){return this._config.chrWidth},VerticalLayout.prototype=Object.create(Layout.prototype),VerticalLayout.prototype.rotateForward=function(t,o,e,n){var r=d3.select("#_ideogram").node().getBoundingClientRect(),i=e.getBoundingClientRect(),s=r.width/i.height*.97,a=this._getYScale(),c="translate(10, 25) scale("+s+", "+a+")";d3.select(e.parentNode).transition().attr("transform",c).on("end",n)},VerticalLayout.prototype.rotateBack=function(t,o,e,n){var r=this.getChromosomeSetTranslate(t);d3.select(e.parentNode).transition().attr("transform",r).on("end",n)},VerticalLayout.prototype.getHeight=function(t){return this._config.chrHeight+1.5*this._margin.top},VerticalLayout.prototype.getChromosomeBandLabelTranslate=function(t){},VerticalLayout.prototype.getChromosomeSetLabelTranslate=function(){return"rotate(-90)"},VerticalLayout.prototype.getChromosomeSetTranslate=function(t){return"rotate(90) translate("+this._margin.top+", -"+this.getChromosomeSetYTranslate(t)+")"},VerticalLayout.prototype.getChromosomeSetYTranslate=function(t){var o=this._getAdditionalOffset();if(!this._config.ploidyDesc)return 10+35*t+this._config.chrWidth+2*o+o*t;if(!this._translate){this._translate=[this._description.getSetSize(0)*this._config.chrWidth*2];for(var e=1;e<this._config.ploidyDesc.length;e++)this._translate[e]=this._translate[e-1]+this._getChromosomeSetSize(e-1)}return this._translate[t]},VerticalLayout.prototype.getChromosomeSetLabelXPosition=function(t){return(this._description.getSetSize(t)*this._config.chrWidth+20)/-2+(this._config.ploidy>1?0:this._config.chrWidth)},VerticalLayout.prototype.getChromosomeSetLabelYPosition=function(t){return-2*this._config.chrWidth},VerticalLayout.prototype.getChromosomeLabelXPosition=function(t){return this._config.chrWidth/-2},VerticalLayout.prototype.getChromosomeLabelYPosition=function(t){return-5},PairedLayout.prototype=Object.create(Layout.prototype),PairedLayout.prototype.rotateForward=function(t,o,e,n){var r=d3.select("#_ideogram").node().getBoundingClientRect(),i=e.getBoundingClientRect(),s=r.width/i.height*.97,a=this._getYScale(),c=t?150:10,l="translate(10, "+c+") scale("+s+", "+a+")";d3.select(e.parentNode).transition().attr("transform",l).on("end",function(){n&&n(),d3.select(e.parentNode).selectAll("g.bandLabel text").attr("transform","rotate(90) translate(0, "+6*Number(!t)+")").attr("text-anchor","middle"),d3.selectAll(".syntenicRegion").style("display","none")})},PairedLayout.prototype.rotateBack=function(t,o,e,n){var r=this.getChromosomeSetTranslate(t);d3.select(e.parentNode).transition().attr("transform",r).on("end",function(){n(),d3.selectAll(".syntenicRegion").style("display",null),d3.select(e.parentNode).selectAll("g.bandLabel text").attr("transform",null).attr("text-anchor",t?null:"end")})},PairedLayout.prototype.getHeight=function(t){return this._config.chrHeight+1.5*this._margin.left},PairedLayout.prototype.getChromosomeBandTickY1=function(t){return t%2?this._config.chrWidth:2*this._config.chrWidth},PairedLayout.prototype.getChromosomeBandTickY2=function(t){return t%2?this._config.chrWidth-this._tickSize:2*this._config.chrWidth+this._tickSize},PairedLayout.prototype.getChromosomeBandLabelAnchor=function(t){return t%2?null:"end"},PairedLayout.prototype.getChromosomeBandLabelTranslate=function(t,o){var e=o%2?10:-this._config.chrWidth-10,n=this._ideo.round(t.px.start+t.px.width/2)+3;return{x:n,y:n,translate:"rotate(-90) translate("+e+", "+n+")"}},PairedLayout.prototype.getChromosomeLabelXPosition=function(t){return-this._tickSize},PairedLayout.prototype.getChromosomeLabelYPosition=function(t){return this._config.chrWidth},PairedLayout.prototype.getChromosomeSetLabelYPosition=function(t){return-2*this._config.chrWidth},PairedLayout.prototype.getChromosomeSetLabelXPosition=function(t){return this._config.chrWidth/-2},PairedLayout.prototype.getChromosomeSetLabelTranslate=function(){return"rotate(-90)"},PairedLayout.prototype.getChromosomeSetTranslate=function(t){return"rotate(90) translate("+this._margin.left+", -"+this.getChromosomeSetYTranslate(t)+")"},PairedLayout.prototype.getChromosomeSetYTranslate=function(t){return 200*(t+1)},SmallLayout.prototype=Object.create(Layout.prototype),SmallLayout.prototype.rotateForward=function(t,o,e,n){var r=d3.select("#_ideogram").node().getBoundingClientRect(),i=e.getBoundingClientRect(),s=r.width/i.height*.97,a=this._getYScale();transform="translate(5, 25) scale("+s+", "+a+")",d3.select(e.parentNode).transition().attr("transform",transform).on("end",n)},SmallLayout.prototype.rotateBack=function(t,o,e,n){var r=this.getChromosomeSetTranslate(t);d3.select(e.parentNode).transition().attr("transform",r).on("end",n)},SmallLayout.prototype.getHeight=function(t){return this._config.rows*(this._config.chrHeight+1.5*this._margin.top)},SmallLayout.prototype.getChromosomeBandLabelTranslate=function(t){},SmallLayout.prototype.getChromosomeSetLabelTranslate=function(){return"rotate(-90)"},SmallLayout.prototype.getChromosomeSetTranslate=function(t){var o=[];this._ideo.getTaxids(function(t){o=t});var e,n,r=this._ideo.config.chromosomes[o[0]].length,i=r/this._config.rows;return t>i-1?(e=this._margin.left+1.4*this._config.chrHeight,n=this.getChromosomeSetYTranslate(t-i)):(e=this._margin.left,n=this.getChromosomeSetYTranslate(t)),"rotate(90) translate("+e+", -"+n+")"},SmallLayout.prototype.getChromosomeSetYTranslate=function(t){var o=this._getAdditionalOffset();return this._margin.left*t+this._config.chrWidth+2*o+o*t},SmallLayout.prototype.getChromosomeSetLabelXPosition=function(t){return(this._description.getSetSize(t)*this._config.chrWidth+20)/-2+(this._config.ploidy>1?0:this._config.chrWidth)},SmallLayout.prototype.getChromosomeSetLabelYPosition=function(t){return-2*this._config.chrWidth},SmallLayout.prototype.getChromosomeLabelXPosition=function(t){return this._config.chrWidth/-2},SmallLayout.prototype.getChromosomeLabelYPosition=function(t){return-5},Ploidy.prototype.getChromosomesNumber=function(t){if(this._config.ploidyDesc){var o=this._config.ploidyDesc[t];return o instanceof Object?Object.keys(o)[0].length:o.length}return this._config.ploidy||1},Color.prototype.getArmColor=function(t,o,e){return this._config.armColors?this._config.armColors[e]:this._config.ancestors?this._getPolyploidArmColor(t,o,e):null},Color.prototype.getBorderColor=function(t,o,e){return o<this._config.ploidy?"#000":this._description.isExists(t,o,e)?"#000":"#fff"},Color.prototype._getPolyploidArmColor=function(t,o,e){return this._description.isExists(t,o,e)?this._config.ancestors[this._description.getAncestor(t,o,e)]:"transparent"},PloidyDescription.prototype.hasDescription=function(){},PloidyDescription.prototype._normilize=function(t){if(!t)return t;var o=[];for(var e in t)"string"==typeof t[e]?o.push({ancestors:t[e],existance:new Array(t[e].length).fill("11")}):o.push({ancestors:Object.keys(t[e])[0],existance:t[e][Object.keys(t[e])[0]]});return o},PloidyDescription.prototype.getSetSize=function(t){return this._description?this._description[t].ancestors.length:1},PloidyDescription.prototype.getAncestor=function(t,o){return this._description?this._description[t].ancestors[o]:""},PloidyDescription.prototype.isExists=function(t,o,e){return!this._description||Number(this._description[t].existance[o][e])>0},Chromosome.getInstance=function(t,o,e){return"telocentric"==t.getModel().centromerePosition?new TelocentricChromosome(t,o,e):new MetacentricChromosome(t,o,e)},Chromosome.prototype._addPArmShape=function(t,o){return o?t.concat(this._getPArmShape()):t},Chromosome.prototype._addQArmShape=function(t,o){return o?t.concat(this._getQArmShape()):t},Chromosome.prototype.render=function(t,o,e){t=t.append("g").attr("class","bands").attr("clip-path","url(#"+this._model.id+"-chromosome-set-clippath)");var n=this._renderPArm(t,o,e),r=this._renderQArm(t,o,e),i=[];i=this._addPArmShape(i,n),i=this._addQArmShape(i,r);var s=this;return t.append("g").attr("class","chromosome-border").selectAll("path").data(i).enter().append("path").attr("fill","transparent").attr("stroke",function(t,n){return s._ideo._color.getBorderColor(o,e,n)}).attr("stroke-width",1).attr("d",function(t){return t.path}).attr("class",function(t){return t.class}),i},Chromosome.prototype._getShapeData=function(){var t=this._model.bands.find(function(t){return"q"==t.name[0]}),o=this._model.bands[this._model.bands.length-1].px.stop;return{x1:0,x2:t?t.px.start:o,x3:o,w:this._config.chrWidth,b:this._config.chrWidth/this._bumpCoefficient}},Chromosome.prototype._getPArmShape=function(){var t=this._getShapeData();return{class:"",path:"M"+t.b+",0 L"+(t.x2-t.b)+",0 Q"+(t.x2+t.b)+","+t.w/2+","+(t.x2-t.b)+","+t.w+" L"+t.b+","+t.w+" Q-"+t.b+","+t.w/2+","+t.b+",0"}},Chromosome.prototype._getQArmShape=function(){var t=this._getShapeData();return{class:"",path:"M"+(t.x2+t.b)+",0 L"+(t.x3-t.b)+",0 Q"+(t.x3+t.b)+","+t.w/2+","+(t.x3-t.b)+","+t.w+" L"+(t.x2+t.b)+","+t.w+" Q"+(t.x2-t.b)+","+t.w/2+","+(t.x2+t.b)+",0"}},Chromosome.prototype._renderBands=function(t,o,e,n,r){var i=this;t.selectAll("path.band."+r).data(n).enter().append("path").attr("id",function(t,o){return i._model.id+"-"+t.name.replace(".","-")}).attr("class",function(t,o){return"band "+r+"-band "+t.stain}).attr("d",function(t,o){var e=i._ideo.round(t.px.start),n=i._ideo.round(t.px.width);return x=e+n,"M "+e+", 0l "+n+" 0 l 0 "+i._config.chrWidth+" l -"+n+" 0 z"}).style("fill",function(t){return i._color.getArmColor(o,e,"p"==r?0:1)})},Chromosome.prototype._renderPArm=function(t,o,e){var n=this._model.bands.filter(function(t){return"p"==t.name[0]});return this._renderBands(t,o,e,n,"p"),Boolean(n.length)},Chromosome.prototype._renderQArm=function(t,o,e){var n=this._model.bands.filter(function(t){return"q"==t.name[0]});return this._renderBands(t,o,e,n,"q"),Boolean(n.length)},TelocentricChromosome.prototype=Object.create(Chromosome.prototype),TelocentricChromosome.prototype._addPArmShape=function(t,o){return t.concat(this._getPArmShape())},TelocentricChromosome.prototype._getPArmShape=function(){var t=this._getShapeData();return t.o=this._pArmOffset,[{class:"acen",path:"M"+t.x2+",1L"+(t.x2-t.o+1)+",1 L"+(t.x2-t.o+1)+","+(t.w-1)+" L"+t.x2+","+(t.w-1)},{class:"gpos100",path:"M"+(t.x2-t.o+1)+",0L"+(t.x2-t.o)+",0 L"+(t.x2-t.o)+","+t.w+" L"+(t.x2-t.o+1)+","+t.w}]},TelocentricChromosome.prototype._getQArmShape=function(){var t=this._getShapeData();return{class:"",path:"M"+t.x2+",0 L"+(t.x3-t.b)+",0 Q"+(t.x3+t.b)+","+t.w/2+","+(t.x3-t.b)+","+t.w+" L"+t.x2+","+t.w}},MetacentricChromosome.prototype=Object.create(Chromosome.prototype),function(){"use strict";function t(t){return"function"==typeof t||"object"==typeof t&&null!==t}function o(t){return"function"==typeof t}function e(t){V=t}function n(t){G=t}function r(){return function(){process.nextTick(l)}}function i(){return function(){R(l)}}function s(){var t=0,o=new J(l),e=document.createTextNode("");return o.observe(e,{characterData:!0}),function(){e.data=t=++t%2}}function a(){var t=new MessageChannel;return t.port1.onmessage=l,function(){t.port2.postMessage(0)}}function c(){return function(){setTimeout(l,1)}}function l(){for(var t=0;q>t;t+=2){var o=tt[t],e=tt[t+1];o(e),tt[t]=void 0,tt[t+1]=void 0}q=0}function h(){try{var t=require,o=t("vertx");return R=o.runOnLoop||o.runOnContext,i()}catch(t){return c()}}function u(t,o){var e=this,n=new this.constructor(m);void 0===n[nt]&&D(n);var r=e._state;if(r){var i=arguments[r-1];G(function(){P(r,n,i,e._result)})}else A(e,n,t,o);return n}function p(t){var o=this;if(t&&"object"==typeof t&&t.constructor===o)return t;var e=new o(m);return x(e,t),e}function m(){}function d(){return new TypeError("You cannot resolve a promise with itself")}function f(){return new TypeError("A promises callback cannot return that same promise.")}function g(t){try{return t.then}catch(t){return at.error=t,at}}function y(t,o,e,n){try{t.call(o,e,n)}catch(t){return t}}function b(t,o,e){G(function(t){var n=!1,r=y(e,o,function(e){n||(n=!0,o!==e?x(t,e):C(t,e))},function(o){n||(n=!0,w(t,o))},"Settle: "+(t._label||" unknown promise"));!n&&r&&(n=!0,w(t,r))},t)}function _(t,o){o._state===it?C(t,o._result):o._state===st?w(t,o._result):A(o,void 0,function(o){x(t,o)},function(o){w(t,o)})}function v(t,e,n){e.constructor===t.constructor&&n===ot&&constructor.resolve===et?_(t,e):n===at?w(t,at.error):void 0===n?C(t,e):o(n)?b(t,e,n):C(t,e)}function x(o,e){o===e?w(o,d()):t(e)?v(o,e,g(e)):C(o,e)}function L(t){t._onerror&&t._onerror(t._result),S(t)}function C(t,o){t._state===rt&&(t._result=o,t._state=it,0!==t._subscribers.length&&G(S,t))}function w(t,o){t._state===rt&&(t._state=st,t._result=o,G(L,t))}function A(t,o,e,n){var r=t._subscribers,i=r.length;t._onerror=null,r[i]=o,r[i+it]=e,r[i+st]=n,0===i&&t._state&&G(S,t)}function S(t){var o=t._subscribers,e=t._state;if(0!==o.length){for(var n,r,i=t._result,s=0;s<o.length;s+=3)n=o[s],r=o[s+e],n?P(e,n,r,i):r(i);t._subscribers.length=0}}function B(){this.error=null}function T(t,o){try{return t(o)}catch(t){return ct.error=t,ct}}function P(t,e,n,r){var i,s,a,c,l=o(n);if(l){if(i=T(n,r),i===ct?(c=!0,s=i.error,i=null):a=!0,e===i)return void w(e,f())}else i=r,a=!0;e._state!==rt||(l&&a?x(e,i):c?w(e,s):t===it?C(e,i):t===st&&w(e,i))}function M(t,o){try{o(function(o){x(t,o)},function(o){w(t,o)})}catch(o){w(t,o)}}function k(){return lt++}function D(t){t[nt]=lt++,t._state=void 0,t._result=void 0,t._subscribers=[]}function I(t){return new dt(this,t).promise}function N(t){var o=this;return new o(Q(t)?function(e,n){for(var r=t.length,i=0;r>i;i++)o.resolve(t[i]).then(e,n)}:function(t,o){o(new TypeError("You must pass an array to race."))})}function H(t){var o=this,e=new o(m);return w(e,t),e}function Y(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function W(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function z(t){this[nt]=k(),this._result=this._state=void 0,this._subscribers=[],m!==t&&("function"!=typeof t&&Y(),this instanceof z?M(this,t):W())}function E(t,o){this._instanceConstructor=t,this.promise=new t(m),this.promise[nt]||D(this.promise),Q(o)?(this._input=o,this.length=o.length,this._remaining=o.length,this._result=new Array(this.length),0===this.length?C(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&C(this.promise,this._result))):w(this.promise,F())}function F(){return new Error("Array Methods must be provided an Array")}function j(){var t;if("undefined"!=typeof global)t=global;else if("undefined"!=typeof self)t=self;else try{t=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var o=t.Promise;(!o||"[object Promise]"!==Object.prototype.toString.call(o.resolve())||o.cast)&&(t.Promise=mt)}var O;O=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};var R,V,X,Q=O,q=0,G=function(t,o){tt[q]=t,tt[q+1]=o,q+=2,2===q&&(V?V(l):X())},$="undefined"!=typeof window?window:void 0,U=$||{},J=U.MutationObserver||U.WebKitMutationObserver,K="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),Z="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,tt=new Array(1e3);X=K?r():J?s():Z?a():void 0===$&&"function"==typeof require?h():c();var ot=u,et=p,nt=Math.random().toString(36).substring(16),rt=void 0,it=1,st=2,at=new B,ct=new B,lt=0,ht=I,ut=N,pt=H,mt=z;z.all=ht,z.race=ut,z.resolve=et,z.reject=pt,z._setScheduler=e,z._setAsap=n,z._asap=G,z.prototype={constructor:z,then:ot,catch:function(t){return this.then(null,t)}};var dt=E;E.prototype._enumerate=function(){for(var t=this.length,o=this._input,e=0;this._state===rt&&t>e;e++)this._eachEntry(o[e],e)},E.prototype._eachEntry=function(t,o){var e=this._instanceConstructor,n=e.resolve;if(n===et){var r=g(t);if(r===ot&&t._state!==rt)this._settledAt(t._state,o,t._result);else if("function"!=typeof r)this._remaining--,this._result[o]=t;else if(e===mt){var i=new e(m);v(i,t,r),this._willSettleAt(i,o)}else this._willSettleAt(new e(function(o){o(t)}),o)}else this._willSettleAt(n(t),o)},E.prototype._settledAt=function(t,o,e){var n=this.promise;n._state===rt&&(this._remaining--,t===st?w(n,e):this._result[o]=e),0===this._remaining&&C(n,this._result)},E.prototype._willSettleAt=function(t,o){var e=this;A(t,void 0,function(t){e._settledAt(it,o,t)},function(t){e._settledAt(st,o,t)})};var ft=j,gt={Promise:mt,polyfill:ft};"function"==typeof define&&define.amd?define(function(){return gt}):"undefined"!=typeof module&&module.exports?module.exports=gt:"undefined"!=typeof this&&(this.ES6Promise=gt),ft()}.call(this),!function(t,o){"function"==typeof define&&define.amd?define(["d3"],o):"object"==typeof exports?module.exports=o(require("d3")):t.d3.promise=o(t.d3)}(this,function(t){var o=function(){function o(t,o){return function(){var e=Array.prototype.slice.call(arguments);return new Promise(function(n,r){var i=function(t,o){return t?void r(Error(t)):void n(o)};o.apply(t,e.concat(i))})}}var e={};return["csv","tsv","json","xml","text","html"].forEach(function(n){e[n]=o(t,t[n])}),e}();return t.promise=o,o});var Ideogram=function(t){if(this.config=JSON.parse(JSON.stringify(t)),this._color=new Color(this.config),this._ploidy=new Ploidy(this.config),this._layout=Layout.getInstance(this.config,this),this._description=new PloidyDescription(this.config.ploidyDesc),this.debug=!1,this.config.ploidy||(this.config.ploidy=1),this.config.bandDir||(this.config.bandDir="../data/bands/"),this.config.container||(this.config.container="body"),this.config.resolution||(this.config.resolution=850),"showChromosomeLabels"in this.config==!1&&(this.config.showChromosomeLabels=!0),this.config.chrMargin||(this.config.chrMargin=10),!this.config.orientation){var o="vertical";this.config.orientation=o}if(!this.config.chrHeight){var e,n=this.config.container,r=document.querySelector(n).getBoundingClientRect();e="vertical"===o?r.height:r.width,"body"==n&&(e=500),this.config.chrHeight=e}if(!this.config.chrWidth){var i=10,e=this.config.chrHeight;900>e&&e>500?i=Math.round(e/40):e>=900&&(i=Math.round(e/45)),this.config.chrWidth=i}this.config.showBandLabels||(this.config.showBandLabels=!1),this.config.brush||(this.config.brush=!1),this.config.rows||(this.config.rows=1),this.bump=Math.round(this.config.chrHeight/125),this.adjustedBump=!1,this.config.chrHeight<200&&(this.adjustedBump=!0,this.bump=4),t.showBandLabels&&(this.config.chrMargin+=20),t.chromosome&&(this.config.chromosomes=[t.chromosome],"showBandLabels"in t==!1&&(this.config.showBandLabels=!0),"rotatable"in t==!1&&(this.config.rotatable=!1)),this.config.showNonNuclearChromosomes||(this.config.showNonNuclearChromosomes=!1),this.initAnnotSettings(),this.config.chrMargin=this.config.chrMargin+this.config.chrWidth+2*this.config.annotTracksHeight,t.onLoad&&(this.onLoadCallback=t.onLoad),t.onDrawAnnots&&(this.onDrawAnnotsCallback=t.onDrawAnnots),t.onBrushMove&&(this.onBrushMoveCallback=t.onBrushMove),this.coordinateSystem="iscn",this.maxLength={bp:0,iscn:0};var s="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/";this.esearch=s+"esearch.fcgi?retmode=json",this.esummary=s+"esummary.fcgi?retmode=json",this.elink=s+"elink.fcgi?retmode=json",this.organisms={9606:{commonName:"Human",scientificName:"Homo sapiens",scientificNameAbbr:"H. sapiens",assemblies:{default:"GCF_000001305.14",GRCh38:"GCF_000001305.14",GRCh37:"GCF_000001305.13"}},10090:{commonName:"Mouse",scientificName:"Mus musculus",scientificNameAbbr:"M. musculus",assemblies:{default:"GCF_000000055.19"}},7227:{commonName:"Fly",scientificName:"Drosophlia melanogaster",scientificNameAbbr:"D. melanogaster"},4641:{commonName:"banana",scientificName:"Musa acuminata",scientificNameAbbr:"M. acuminata",assemblies:{default:"mock"}}},this.chromosomesArray=[],this.bandsToShow=[],this.chromosomes={},this.numChromosomes=0,this.bandData={},this.init()};Ideogram.prototype.getBands=function(content,taxid,chromosomes){var lines={},delimiter,tsvLines,columns,line,stain,chr,i,prefetched,init,tsvLinesLength,source,start,stop,firstColumn;if("chrBands"===content.slice(0,8)&&(source="native"),"undefined"==typeof chrBands&&"native"!==source?(delimiter=/\t/,tsvLines=content.split(/\r\n|\n/),init=1):(delimiter=/ /,tsvLines="native"===source?eval(content):content,init=0),firstColumn=tsvLines[0].split(delimiter)[0],source="#chromosome"==firstColumn?"ncbi":"#chrom"==firstColumn?"ucsc":"native",tsvLinesLength=tsvLines.length,"ncbi"===source||"native"===source)for(i=init;i<tsvLinesLength;i++)columns=tsvLines[i].split(delimiter),chr=columns[0],"undefined"!=typeof chromosomes&&chromosomes.indexOf(chr)===-1||(chr in lines==!1&&(lines[chr]=[]),stain=columns[7],columns[8]&&(stain+=columns[8]),line={chr:chr,bp:{start:parseInt(columns[5],10),stop:parseInt(columns[6],10)},iscn:{start:parseInt(columns[3],10),stop:parseInt(columns[4],10)},px:{start:-1,stop:-1,width:-1},name:columns[1]+columns[2],stain:stain,taxid:taxid},lines[chr].push(line));else if("ucsc"===source)for(i=init;i<tsvLinesLength;i++)columns=tsvLines[i].split(delimiter),columns[0]==="chr"+chromosomeName&&(stain=columns[4],"n/a"===stain&&(stain="gpos100"),start=parseInt(columns[1],10),stop=parseInt(columns[2],10),line={chr:columns[0].split("chr")[1],bp:{start:start,stop:stop},iscn:{start:start,stop:stop},px:{start:-1,stop:-1,width:-1},name:columns[3],stain:stain,taxid:taxid},lines[chr].push(line));return lines},Ideogram.prototype.getChromosomeModel=function(t,o,e,n){var r,i,s,a,c,l,h={},u=this.config.chrHeight,p=this.maxLength;if(c=this.coordinateSystem,l="undefined"!=typeof t,l?(h.name=o,h.length=t[t.length-1][c].stop,h.type="nuclear"):h=o,h.chrIndex=n,h.id="chr"+h.name+"-"+e,this.config.fullChromosomeLabels===!0){var m=this.organisms[e].scientificNameAbbr;h.name=m+" chr"+h.name}if(a=h.length,s=0,l)for(var d=0;d<t.length;d++)r=t[d],i=u*h.length/p[c]*(r[c].stop-r[c].start)/a,t[d].px={start:s,stop:s+i,width:i},s=t[d].px.stop,l&&"acen"===r.stain&&"p"===r.name[0]&&(h.pcenIndex=d);else s=u*h.length/p[c];return h.width=s,h.scale={},this.config.multiorganism===!0?(h.scale.bp=1,h.scale.iscn=u*a/p.bp):(h.scale.bp=u/p.bp,l&&(h.scale.iscn=u/p.iscn)),h.bands=t,h.centromerePosition="",l&&t[0].bp.stop-t[0].bp.start==1&&(h.centromerePosition="telocentric",h.bands=h.bands.slice(1)),h},Ideogram.prototype.drawChromosomeLabels=function(t){var o=this;d3.selectAll(".chromosome-set-container").append("text").data(o.chromosomesArray).attr("class","chrSetLabel").attr("transform",o._layout.getChromosomeSetLabelTranslate()).attr("x",function(t,e){return o._layout.getChromosomeSetLabelXPosition(e)}).attr("y",function(t,e){return o._layout.getChromosomeSetLabelYPosition(e)}).text(function(t,o){return t.name}).attr("text-anchor","middle"),d3.selectAll(".chromosome-set-container").each(function(t,e){d3.select(this).selectAll(".chromosome").append("text").attr("class","chrLabel").attr("transform",o._layout.getChromosomeSetLabelTranslate()).attr("x",function(t,e){return o._layout.getChromosomeLabelXPosition(e)}).attr("y",function(t,e){return o._layout.getChromosomeLabelYPosition(e)}).text(function(t,n){return o._description.getAncestor(e,n)}).attr("text-anchor","middle")})},Ideogram.prototype.drawBandLabels=function(t){var o,e,n,r,i,s,a=this;i=this,n=[];for(r in t)for(e in t[r])n.push(t[r][e]);var c={};chrIndex=0;for(var o=0;o<n.length;o++){chrIndex+=1,s=n[o],e=d3.select("#"+s.id);var l,h,u=this.config.chrMargin*chrIndex,i=this;l=u,h=u-8,1==chrIndex&&"perspective"in this.config&&"comparative"==this.config.perspective&&(l+=18,h+=18),c[s.id]=[],e.selectAll("text").data(s.bands).enter().append("g").attr("class",function(t,o){return"bandLabel bsbsl-"+o}).attr("transform",function(t){var e=a._layout.getChromosomeBandLabelTranslate(t,o),n=e.x;e.y;return c[s.id].push(n+13),e.translate}).append("text").attr("text-anchor",a._layout.getChromosomeBandLabelAnchor(o)).text(function(t){
return t.name});var p=ModelAdapter.getInstance(i.chromosomesArray[o]);Chromosome.getInstance(p,i.config,i);e.selectAll("line.bandLabelStalk").data(s.bands).enter().append("g").attr("class",function(t,o){return"bandLabelStalk bsbsl-"+o}).attr("transform",function(t){var o,e;return o=i.round(t.px.start+t.px.width/2),c[s.id].push(o+13),e=-10,"translate("+o+","+e+")"}).append("line").attr("x1",0).attr("y1",function(){return a._layout.getChromosomeBandTickY1(o)}).attr("x2",0).attr("y2",function(){return a._layout.getChromosomeBandTickY2(o)})}for(var o=0;o<n.length;o++){s=n[o];var m,d,f,g,y,b,_=c[s.id].length,v=[];for(m=0,b=5,d=0;d<_;d++)g=c[s.id][d],g<m+b==!1?(v.push(d),f!==d&&(prevTextBoxLeft=c[s.id][d],prevTextBoxWidth=36,y=prevTextBoxLeft+prevTextBoxWidth),g<y+b?(f=d,m=y):v.push(d)):(f=d,m=y);for(var x,L=[],C=v.length,x=0;x<C;x++)d=v[x],L.push("#"+s.id+" .bsbsl-"+d);this.bandsToShow=this.bandsToShow.concat(L)}},Ideogram.prototype.rotateChromosomeLabels=function(t,o,e,n){var r,i,s,a,c,l,h,u;i=this.config.chrWidth,r=this.config.chrMargin*o,l=this.config.numAnnotTracks,s=this,"undefined"==typeof n||!n.hasOwnProperty("x")||1==n.x&&1==n.y?(a=-8,c=-16,n={x:1,y:1},h=""):(h="scale("+n.x+","+n.y+")",a=-6,c=""===n?-16:-14),"vertical"==e||""==e?t.selectAll("text.chrLabel").attr("transform",h).selectAll("tspan").attr("x",a).attr("y",function(t,n){var r=o-1;(l>1||""==e)&&(r-=1),chrMargin2=-4,s.config.showBandLabels===!0&&(chrMargin2=s.config.chrMargin+i+26);var a=s.config.chrMargin*r;return l>1==0&&(a+=1),a+chrMargin2}):(o-=1,chrMargin2=-i-2,s.config.showBandLabels===!0&&(chrMargin2=s.config.chrMargin+8),u=s.config.annotTracksHeight,"overlay"!==s.config.annotationsLayout&&(u*=2),t.selectAll("text.chrLabel").attr("transform","rotate(-90)"+h).selectAll("tspan").attr("x",function(t,e){return r=s.config.chrMargin*o,a=-(r+chrMargin2)+3+u,a/=n.x}).attr("y",c))},Ideogram.prototype.rotateBandLabels=function(t,o,e){var n,r,i,s,a,c=this;a=t.selectAll(".bandLabel"),r=this.config.chrWidth,n=this.config.chrMargin*o,s=t.attr("data-orientation"),"undefined"==typeof e?(e={x:1,y:1},i=""):i="scale("+e.x+","+e.y+")",1==o&&"perspective"in this.config&&"comparative"==this.config.perspective?a.attr("transform",function(t){var o,e;return o=8-n-26,e=c.round(2+t.px.start+t.px.width/2),"rotate(-90)translate("+o+","+e+")"}).selectAll("text").attr("text-anchor","end"):"vertical"==s?a.attr("transform",function(t){var o,e;return o=8-n,e=c.round(2+t.px.start+t.px.width/2),"rotate(-90)translate("+o+","+e+")"}).selectAll("text").attr("transform",i):(a.attr("transform",function(t){var o,r;return o=c.round(-8*e.x+t.px.start+t.px.width/2),r=n-10,"translate("+o+","+r+")"}).selectAll("text").attr("transform",i),t.selectAll(".bandLabelStalk line").attr("transform",i))},Ideogram.prototype.round=function(t){return Math.round(100*t)/100},Ideogram.prototype.drawChromosomeNoBands=function(t,o){var e,n,r,i,s,a=this;n=a.bump,r=a.config.chrMargin*o,i=a.config.chrWidth,s=t.width,e=d3.select("svg").append("g").attr("id",t.id).attr("class","chromosome noBands"),s<1||(e.append("path").attr("class","upstream chromosomeBorder").attr("d","M "+(n-n/2+.1)+" "+r+" q -"+n+" "+i/2+" 0 "+i),e.append("path").attr("class","downstream chromosomeBorder").attr("d","M "+s+" "+r+" q "+n+" "+i/2+" 0 "+i),e.append("line").attr("class","cb-top chromosomeBorder").attr("x1",n/2).attr("y1",r).attr("x2",s).attr("y2",r),e.append("line").attr("class","cb-bottom chromosomeBorder").attr("x1",n/2).attr("y1",i+r).attr("x2",s).attr("y2",i+r),e.append("path").attr("class","chromosomeBody").attr("d","M "+n/2+" "+r+" l "+(s-n/2)+" 0 l 0 "+i+" l -"+(s-n/2)+" 0 z"))},Ideogram.prototype.drawChromosome=function(t,o,e,n){var r=ModelAdapter.getInstance(t),i=e.append("g").attr("id",t.id).attr("class","chromosome "+r.getCssClass()).attr("transform","translate(0, "+20*n+")");return Chromosome.getInstance(r,this.config,this).render(i,o,n)},Ideogram.prototype.rotateAndToggleDisplay=function(t){if(this.config.taxid){var o=Number(d3.select(t.parentNode).attr("data-set-number")),e=Array.prototype.slice.call(d3.select(t.parentNode).selectAll("g.chromosome")._groups[0]).indexOf(t);return this._layout.rotate(o,e,t)}},Ideogram.prototype.convertBpToPx=function(t,o){var e,n,r,i,s;for(e=0;e<t.bands.length;e++)if(n=t.bands[e],o>=n.bp.start&&o<=n.bp.stop)return r=(n.iscn.stop-n.iscn.start)/(n.bp.stop-n.bp.start),i=n.iscn.start+(o-n.bp.start)*r,s=30+n.px.start+n.px.width*(i-n.iscn.start)/(n.iscn.stop-n.iscn.start);throw new Error("Base pair out of range.  bp: "+o+"; length of chr"+t.name+": "+n.bp.stop)},Ideogram.prototype.convertPxToBp=function(t,o){var e,n,r;for(e=0;e<t.bands.length;e++)if(n=t.bands[e],o>=n.px.start&&o<=n.px.stop)return pxToIscnScale=(n.iscn.stop-n.iscn.start)/(n.px.stop-n.px.start),r=n.iscn.start+(o-n.px.start)*pxToIscnScale,bp=n.bp.start+(n.bp.stop-n.bp.start)*(r-n.iscn.start)/(n.iscn.stop-n.iscn.start),Math.round(bp);throw new Error("Pixel out of range.  px: "+bp+"; length of chr"+t.name+": "+n.px.stop)},Ideogram.prototype.drawSynteny=function(t){var o,e,n,r,i,s,a,c=(new Date).getTime(),l=this;for(n=d3.select("svg").insert("g",":first-child").attr("class","synteny"),r=0;r<t.length;r++){regions=t[r],o=regions.r1,e=regions.r2,i="#CFC","color"in regions&&(i=regions.color),s=1,"opacity"in regions&&(s=regions.opacity),o.startPx=this.convertBpToPx(o.chr,o.start),o.stopPx=this.convertBpToPx(o.chr,o.stop),e.startPx=this.convertBpToPx(e.chr,e.start),e.stopPx=this.convertBpToPx(e.chr,e.stop),a=o.chr.id+"_"+o.start+"_"+o.stop+"___"+e.chr.id+"_"+e.start+"_"+e.stop,syntenicRegion=n.append("g").attr("class","syntenicRegion").attr("id",a).on("click",function(){var t=this,o=d3.selectAll(".syntenicRegion").filter(function(o,e){return this!==t});o.classed("hidden",!o.classed("hidden"))}).on("mouseover",function(){var t=this;d3.selectAll(".syntenicRegion").filter(function(o,e){return this!==t}).classed("ghost",!0)}).on("mouseout",function(){d3.selectAll(".syntenicRegion").classed("ghost",!1)});var h=this._layout.getChromosomeSetYTranslate(0),u=this._layout.getChromosomeSetYTranslate(1)-l.config.chrWidth;syntenicRegion.append("polygon").attr("points",h+", "+o.startPx+" "+h+", "+o.stopPx+" "+u+", "+e.stopPx+" "+u+", "+e.startPx).attr("style","fill: "+i+"; fill-opacity: "+s),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",h).attr("x2",u).attr("y1",o.startPx).attr("y2",e.startPx),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",h).attr("x2",u).attr("y1",o.stopPx).attr("y2",e.stopPx)}var p=(new Date).getTime();l.debug&&console.log("Time in drawSyntenicRegions: "+(p-c)+" ms")},Ideogram.prototype.initAnnotSettings=function(){if(this.config.annotationsPath||this.config.localAnnotationsPath||this.annots||this.config.annotations){if(!this.config.annotationHeight){var t=Math.round(this.config.chrHeight/100);this.config.annotationHeight=t}this.config.annotationTracks?this.config.numAnnotTracks=this.config.annotationTracks.length:this.config.numAnnotTracks=1,this.config.annotTracksHeight=this.config.annotationHeight*this.config.numAnnotTracks,"undefined"==typeof this.config.barWidth&&(this.config.barWidth=3)}else this.config.annotTracksHeight=0;"undefined"==typeof this.config.annotationsColor&&(this.config.annotationsColor="#F00")},Ideogram.prototype.drawAnnots=function(t){var o,e,n,r,i,s,a=this,c=[],l=a.chromosomes[a.config.taxid];if("annots"in t[0])return a.drawProcessedAnnots(t);for(s in l)c.push({chr:s,annots:[]});for(o=0;o<t.length;o++)for(n=t[o],e=0;e<c.length;e++)if(n.chr===c[e].chr){r=[n.name,n.start,n.stop-n.start],"color"in n&&r.push(n.color),"shape"in n&&r.push(n.shape),c[e].annots.push(r);break}i=["name","start","length"],"color"in t[0]&&i.push("color"),"shape"in t[0]&&i.push("shape"),a.rawAnnots={keys:i,annots:c},a.annots=a.processAnnotData(a.rawAnnots),a.drawProcessedAnnots(a.annots)},Ideogram.prototype.processAnnotData=function(t){var o,e,n,r,i,s,a,c,l,h,u,p,m=t.keys,t=t.annots,d=this;for(r=[],o=0;o<t.length;o++)for(i=t[o],r.push({chr:i.chr,annots:[]}),e=0;e<i.annots.length;e++){s=i.chr,c=i.annots[e],n={};for(var f=0;f<m.length;f++)n[m[f]]=c[f];n.stop=n.start+n.length,a=d.chromosomes[9606][s],l=d.convertBpToPx(a,n.start),h=d.convertBpToPx(a,n.stop),u=Math.round((l+h)/2)-28,p=d.config.annotationsColor,d.config.annotationTracks?(n.trackIndex=c[3],p=d.config.annotationTracks[n.trackIndex].color):n.trackIndex=0,"color"in n&&(p=n.color),n.chr=s,n.chrIndex=o,n.px=u,n.color=p,r[o].annots.push(n)}return r},Ideogram.prototype.getHistogramBars=function(t){var o,e,n,r,i,s,a,c,l,h,u,p,m,d,f,g,y,b,_=(new Date).getTime(),v=!1,x=this;u=[],f=x.config.barWidth,r=x.chromosomes[x.config.taxid],y=x.config.annotationsColor,b="histogramScaling"in x.config?x.config.histogramScaling:"relative","undefined"==typeof x.maxAnnotsPerBar&&(x.maxAnnotsPerBar={},v=!0);for(n in r){for(chrModel=r[n],l=chrModel.chrIndex,lastBand=chrModel.bands[chrModel.bands.length-1],i=lastBand.px.stop,numBins=Math.round(i/f),p={chr:n,annots:[]},o=0;o<numBins;o++)s=o*f-x.bump,bp=x.convertPxToBp(chrModel,s+x.bump),p.annots.push({bp:bp,px:s-x.bump,count:0,chrIndex:l,chrName:n,color:y,annots:[]});u.push(p)}for(n in t)for(a=t[n].annots,c=t[n].chr,chrModel=r[c],l=chrModel.chrIndex-1,barAnnots=u[l].annots,o=0;o<a.length;o++)for(h=a[o],s=h.px-x.bump,e=0;e<barAnnots.length;e++)if(m=barAnnots[e].px,d=m+f,e==barAnnots.length-1&&(d+=f),s>=m&&s<d){u[l].annots[e].count+=1,u[l].annots[e].annots.push(h);break}if(1==v||"relative"==b){for(g=0,o=0;o<u.length;o++)for(t=u[o].annots,e=0;e<t.length;e++)barCount=t[e].count,barCount>g&&(g=barCount);x.maxAnnotsPerBar[n]=g}for(o=0;o<u.length;o++)for(t=u[o].annots,e=0;e<t.length;e++)barCount=t[e].count,height=barCount/x.maxAnnotsPerBar[n]*x.config.chrMargin,u[o].annots[e].height=height;var L=(new Date).getTime();return x.debug&&console.log("Time spent in getHistogramBars: "+(L-_)+" ms"),x.bars=u,u},Ideogram.prototype.drawProcessedAnnots=function(t){var o,e,n,r,i,s,a,c,l,h,u,p,m=this;o=this.config.chrMargin,e=this.config.chrWidth,n="tracks",this.config.annotationsLayout&&(n=this.config.annotationsLayout),"histogram"===n&&(t=m.getHistogramBars(t)),r=m.config.annotationHeight,i="l -"+r+" "+2*r+" l "+2*r+" 0 z",a=r,s="m -"+a+", "+a+"a "+a+","+a+" 0 1,0 "+2*a+",0a "+a+","+a+" 0 1,0 -"+2*a+",0",c=d3.selectAll(".chromosome").data(t).selectAll("path.annot").data(function(t){return t.annots}).enter(),"tracks"===n?c.append("g").attr("id",function(t,o){return t.id}).attr("class","annot").attr("transform",function(t,o,e){var n=m.config.chrWidth+t.trackIndex*r*2;return"translate("+t.px+","+n+")"}).append("path").attr("d",function(t){return t.shape&&"triangle"!==t.shape?"circle"===t.shape?s:void 0:"m0,0"+i}).attr("fill",function(t){return t.color}):"overlay"===n?c.append("polygon").attr("id",function(t,o){return t.id}).attr("class","annot").attr("points",function(t){return l=t.px-.5,h=t.px+.5,u=e,p=0,l+","+u+" "+h+","+u+" "+h+","+p+" "+l+","+p}).attr("fill",function(t){return t.color}):"histogram"===n&&c.append("polygon").attr("class","annot").attr("points",function(t){l=t.px+m.bump,h=t.px+m.config.barWidth+m.bump,u=e,p=e+t.height;var o=m.chromosomesArray[t.chrIndex-1].width;return h>o&&(h=o),l+","+u+" "+h+","+u+" "+h+","+p+" "+l+","+p}).attr("fill",function(t){return t.color}),m.onDrawAnnotsCallback&&m.onDrawAnnotsCallback()},Ideogram.prototype.onBrushMove=function(){call(this.onBrushMoveCallback)},Ideogram.prototype.createBrush=function(t,o){function e(){var t=d3.event.selection.map(u.invert),o=Math.floor(t[0]),e=Math.ceil(t[1]);i.selectedRegion={from:o,to:e,extent:e-o},i.onBrushMove&&i.onBrushMoveCallback()}var n,r,i=this,s=i.config.chrWidth+6.5,a=i.config.chrHeight,c=i.chromosomesArray[0],l=c.bands[c.bands.length-1].bp.stop,h=this._layout.getMargin().left,u=d3.scaleLinear().domain([0,d3.max(c.bands,function(t){return t.bp.stop})]).range([h,d3.max(c.bands,function(t){return t.px.stop})+h]);"undefined"==typeof t&&(t=Math.floor(l/10)),"undefined"==typeof right&&(o=Math.ceil(2*t)),n=i.convertBpToPx(c,t),r=i.convertBpToPx(c,o),i.selectedRegion={from:t,to:o,extent:o-t},i.brush=d3.brushX().extent([[h,0],[a+h,s]]).on("brush",e);var p=this._layout.getChromosomeSetYTranslate(0)+(i.config.chrWidth-s)/2;d3.select("#_ideogram").append("g").attr("class","brush").attr("transform","translate(0, "+p+")").call(i.brush).call(i.brush.move,[n,r])},Ideogram.prototype.onLoad=function(){call(this.onLoadCallback)},Ideogram.prototype.onDrawAnnots=function(){call(this.onDrawAnnotsCallback)},Ideogram.prototype.getBandColorGradients=function(){var t,o,e,n,r,i,s="";t=[["gneg","#FFF","#FFF","#DDD"],["gpos25","#C8C8C8","#DDD","#BBB"],["gpos33","#BBB","#BBB","#AAA"],["gpos50","#999","#AAA","#888"],["gpos66","#888","#888","#666"],["gpos75","#777","#777","#444"],["gpos100","#444","#666","#000"],["acen","#FEE","#FEE","#FDD"],["noBands","#BBB","#BBB","#AAA"]];for(var a=0;a<t.length;a++)o=t[a][0],e=t[a][1],n=t[a][2],r=t[a][3],s+='<linearGradient id="'+o+'" x1="0%" y1="0%" x2="0%" y2="100%">',s+="gneg"==o?'<stop offset="70%" stop-color="'+n+'" /><stop offset="95%" stop-color="'+r+'" /><stop offset="100%" stop-color="'+e+'" />':'<stop offset="5%" stop-color="'+e+'" /><stop offset="15%" stop-color="'+n+'" /><stop offset="60%" stop-color="'+r+'" />',s+="</linearGradient>";return s+='<pattern id="stalk" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#CCE" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#88B; stroke-width:0.7;" /></pattern><pattern id="gvar" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(-30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#DDF" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#99C; stroke-width:0.7;" /></pattern>',s="<defs>"+s+"</defs>",i='<style>.gneg {fill: url("#gneg")} .gpos25 {fill: url("#gpos25")} .gpos33 {fill: url("#gpos33")} .gpos50 {fill: url("#gpos50")} .gpos66 {fill: url("#gpos66")} .gpos75 {fill: url("#gpos75")} .gpos100 {fill: url("#gpos100")} .acen {fill: url("#acen")} .stalk {fill: url("#stalk")} .gvar {fill: url("#gvar")} .noBands {fill: url("#noBands")} </style>',s=i+s},Ideogram.prototype.getTaxidFromEutils=function(t){var o,e,n,r=this;o=r.config.organism,e=r.esearch+"&db=taxonomy&term="+o,d3.json(e,function(o){return n=o.esearchresult.idlist[0],t(n)})},Ideogram.prototype.getTaxids=function(t){var o,e,n,r,i,s,a,c,l,h,u=this;if(s="taxid"in u.config,u.config.multiorganism="organism"in u.config&&u.config.organism instanceof Array||s&&u.config.taxid instanceof Array,h=u.config.multiorganism,"organism"in u.config){for(r=h?u.config.organism:[u.config.organism],e=[],a={},i=0;i<r.length;i++){n=r[i];for(o in u.organisms)u.organisms[o].commonName.toLowerCase()===n&&(e.push(o),h&&(a[o]=u.config.chromosomes[n]))}0==e.length?(promise=new Promise(function(t,o){u.getTaxidFromEutils(t)}),promise.then(function(t){return o=t,e.push(o),u.config.taxids=e,u.organisms[o]={commonName:"",scientificName:u.config.organism,scientificNameAbbr:""},new Promise(function(t,o){u.getAssemblyAndChromosomesFromEutils(t)})}).then(function(n){c=n[0],l=n[1],u.config.chromosomes=l,u.organisms[o].assemblies={default:c},t(e)})):(u.config.taxids=e,h&&(u.config.chromosomes=a),t(e))}else h?(u.coordinateSystem="bp",s&&(e=u.config.taxid)):(s&&(e=[u.config.taxid]),u.config.taxids=e),t(e)},Ideogram.prototype.sortChromosomes=function(t,o){var e="nuclear"===t.type,n="nuclear"===o.type,r="chloroplast"===t.type,i="chloroplast"===o.type,s="mitochondrion"===t.type,a="mitochondrion"===o.type;s&&"MT"!==t.name,a&&"MT"!==o.name;return e&&n?naturalSort(t.name,o.name):!e&&n?1:s&&i?1:r&&a?-1:s||r||!a&&!i?void 0:-1},Ideogram.prototype.getAssemblyAndChromosomesFromEutils=function(t){var o,e,n,r,i,s,a,c,l,h,u,p,m,d,f,g,y,b=this;organism=b.config.organism,o=[],n=[],r=b.esearch+"&db=assembly&term=%22"+organism+"%22[organism]AND%20(%22latest%20refseq%22[filter])%20AND%20%22chromosome%20level%22[filter]";var _=d3.promise.json(r);_.then(function(t){return i=t.esearchresult.idlist[0],s=b.esummary+"&db=assembly&id="+i,d3.promise.json(s)}).then(function(t){return a=t.result[i].rsuid,e=t.result[i].assemblyaccession,o.push(e),c=b.elink+"&db=nuccore&linkname=gencoll_nuccore_chr&from_uid="+a,d3.promise.json(c)}).then(function(t){return l=t.linksets[0].linksetdbs[0].links.join(","),h=b.esummary+"&db=nucleotide&id="+l,d3.promise.json(h)}).then(function(e){u=e.result;for(var r in u)if(p=u[r],"uids"!==r){if("mitochondrion"===p.genome){if(!b.config.showNonNuclearChromosomes)continue;y=p.genome,m=p.subtype.split("|").indexOf("plasmid"),d=m===-1?"MT":p.subname.split("|")[m]}else if("chloroplast"===p.genome||"plastid"===p.genome){if(y="chloroplast",!b.config.showNonNuclearChromosomes)continue;d="CP"}else y="nuclear",m=p.subtype.split("|").indexOf("chromosome"),d=p.subname.split("|")[m],"undefined"!=typeof d&&"chr"===d.substr(0,3)&&(d=d.substr(3));f=p.slen,g={name:d,length:f,type:y},n.push(g)}return n=n.sort(b.sortChromosomes),o.push(n),b.coordinateSystem="bp",t(o)})},Ideogram.prototype.initDrawChromosomes=function(t){var o,e,n,r,i,s,a=this,c=a.config.taxids,l=0,h=0,u=d3.select("defs");for(e=0;e<c.length;e++){for(o=c[e],r=a.config.chromosomes[o],a.chromosomes[o]={},n=0;n<r.length;n++){i=r[n],bands=t[l],l+=1,s=a.getChromosomeModel(bands,i,o,l),a.chromosomes[o][i]=s,a.chromosomesArray.push(s);for(var p,m=d3.select("svg").append("g").attr("class","chromosome-set-container").attr("data-set-number",n).attr("transform",a._layout.getChromosomeSetTranslate(h++)).attr("id",s.id+"-chromosome-set"),d=0;d<this._ploidy.getChromosomesNumber(n);d++)p=a.drawChromosome(s,l-1,m,d);u.append("clipPath").attr("id",s.id+"-chromosome-set-clippath").selectAll("path").data(p).enter().append("path").attr("d",function(t){return t.path}).attr("class",function(t){return t.class})}a.config.showBandLabels===!0&&a.drawBandLabels(a.chromosomes)}},Ideogram.prototype.init=function(){function t(){c.config.annotationsPath&&d3.json(c.config.annotationsPath,function(t){c.rawAnnots=t}),s="",c.config.showChromosomeLabels&&(s+="horizontal"==c.config.orientation?"labeledLeft ":"labeled "),c.config.annotationsLayout&&"overlay"===c.config.annotationsLayout&&(s+="faint");var t=c.getBandColorGradients(),o=c._layout.getHeight(r);d3.select(c.config.container).append("svg").attr("id","_ideogram").attr("class",s).attr("width","97%").attr("height",o).html(t);e()}function o(){var t,o,e,n,r,s,a,n,l,p,m,d,f;if(h=[],u=0,c.config.multiorganism===!0)for(c.coordinateSystem="bp",m=c.config.taxids,i=0;i<m.length;i++)p=m[i];else"undefined"==typeof c.config.taxid&&(c.config.taxid=c.config.taxids[0]),p=c.config.taxid,m=[p],c.config.taxids=m;"chromosomes"in c.config&&(d=c.config.chromosomes),c.config.multiorganism&&(f=d),c.config.chromosomes={};var g=(new Date).getTime();for(t=0;t<m.length;t++)if(p=m[t],c.config.multiorganism&&(d=f[p]),"iscn"===c.coordinateSystem||c.config.multiorganism)for(a=c.bandData[p],l=c.getBands(a,p,d),d=Object.keys(l),c.config.chromosomes[p]=d.slice(),c.numChromosomes+=c.config.chromosomes[p].length,o=0;o<d.length;o++)e=d[o],n=l[e],h.push(n),r={iscn:n[n.length-1].iscn.stop,bp:n[n.length-1].bp.stop},r.iscn>c.maxLength.iscn&&(c.maxLength.iscn=r.iscn),r.bp>c.maxLength.bp&&(c.maxLength.bp=r.bp);else if("bp"==c.coordinateSystem)for(c.config.chromosomes[p]=d.slice(),c.numChromosomes+=c.config.chromosomes[p].length,o=0;o<d.length;o++)s=d[o],s.length>c.maxLength.bp&&(c.maxLength.bp=s.length);var y=(new Date).getTime();c.debug&&console.log("Time in processBandData: "+(y-g)+" ms")}function e(){function t(){"undefined"!=typeof timeout&&window.clearTimeout(timeout),c.annots=c.processAnnotData(c.rawAnnots),c.drawProcessedAnnots(c.annots),c.initCrossFilter&&c.initCrossFilter()}try{var o,e=(new Date).getTime();if(c.initDrawChromosomes(h),c.config.annotationsPath&&(c.rawAnnots?t():!function o(){timeout=setTimeout(function(){c.rawAnnots?t():o()},50)}()),c.config.showBandLabels===!0){var n=c.bandsToShow.join(","),r=(new Date).getTime();d3.selectAll(".bandLabel, .bandLabelStalk").style("display","none"),d3.selectAll(n).style("display","");var i=(new Date).getTime();if(c.debug&&console.log("Time in showing bands: "+(i-r)+" ms"),"vertical"===c.config.orientation)for(var o=0;o<c.chromosomesArray.length;o++)c.rotateChromosomeLabels(d3.select("#"+c.chromosomesArray[o].id),o)}c.config.showChromosomeLabels===!0&&c.drawChromosomeLabels(c.chromosomes),c.config.brush===!0&&c.createBrush(),c.config.annotations&&c.drawAnnots(c.config.annotations);var s=(new Date).getTime();c.debug&&console.log("Time in drawChromosome: "+(s-e)+" ms");var a=(new Date).getTime();c.debug&&console.log("Time constructing ideogram: "+(a-l)+" ms"),c.onLoadCallback&&c.onLoadCallback(),"rotatable"in c.config&&c.config.rotatable===!1?d3.selectAll(".chromosome").style("cursor","default"):d3.selectAll(".chromosome").on("click",function(){ideogram.rotateAndToggleDisplay(this)})}catch(t){console.log(t)}}var n,r,i,s,a,c=this,l=(new Date).getTime(),h=[],u=0,p=0,m=this.config.resolution,d=new Promise(function(t,o){c.getTaxids(t)});d.then(function(e){for(r=e[0],c.config.taxid=r,c.config.taxids=e,i=0;i<e.length;i++)r=e[i],c.config.assembly||(c.config.assembly="default"),a=c.organisms[r].assemblies[c.config.assembly],n={9606:"native/ideogram_9606_"+a+"_"+m+"_V1.js",10090:"native/ideogram_10090_"+a+"_NA_V2.js"},"undefined"==typeof chrBands&&r in n?d3.request(c.config.bandDir+n[r]).on("beforesend",function(t){t.taxid=r}).get(function(n,r){c.bandData[r.taxid]=r.response,p+=1,p==e.length&&(o(),t())}):("undefined"!=typeof chrBands&&(c.bandData[r]=chrBands),o(),t())})},Ideogram.prototype.unpackAnnots=function(){var t,o,e,n=[],r=this,i=r.annots;for(e=0;e<i.length;e++)t=i[e],o=t.annots,n=n.concat(o);return n},Ideogram.prototype.packAnnots=function(t){var o,e,n,r=[],i=this,s=i.annots;for(var o in s)r.push({chr:s[o].chr,annots:[]});for(n=0;n<t.length;n++)e=t[n],r[e.chrIndex].annots.push(e);return r},Ideogram.prototype.initCrossFilter=function(){var t,o,e=this,n=e.rawAnnots.keys;for(e.unpackedAnnots=e.unpackAnnots(),e.crossfilter=crossfilter(e.unpackedAnnots),e.annotsByFacet={},e.facets=n.slice(3,n.length),t=0;t<e.facets.length;t++)o=e.facets[t],e.annotsByFacet[o]=e.crossfilter.dimension(function(t){return t[o]})},Ideogram.prototype.filterAnnots=function(t){var o,e,n,r,i=Date.now(),s={},a=this;if(0==Object.keys(t).length)n=a.unpackedAnnots;else{for(o=0;o<a.facets.length;o++)e=a.facets[o],r=e in t?function(o){if(o in t[e])return!0}:null,a.annotsByFacet[e].filter(r),s[e]=a.annotsByFacet[e].group().top(1/0);n=a.annotsByFacet[e].top(1/0)}for(o<0;o<a.facets.length;o++)a.annotsByFacet[e].filterAll();return n=a.packAnnots(n),d3.selectAll("polygon.annot").remove(),a.drawAnnots(n),console.log("Time in filterAnnots: "+(Date.now()-i)+" ms"),s};