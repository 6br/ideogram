var Ideogram=function(c){this.config=c;this.debug=!1;this.config.container||(this.config.container="body");this.config.resolution||(this.config.resolution=850);this.config.brush||(this.config.brush=!1);this.config.rows||(this.config.rows=1);!1==="chrHeight"in c&&(c.chrHeight=500);this.bump=Math.round(c.chrHeight/125);c.showBandLabels&&(this.config.chrMargin+=20);this.config.annotationsPath?(this.config.annotationHeight||(this.config.annotationHeight=3),this.config.numAnnotTracks=this.config.annotationTracks?
this.config.annotationTracks.length:1,this.config.annotTracksHeight=this.config.annotationHeight*this.config.numAnnotTracks,"undefined"===typeof this.config.barWidth&&(this.config.barWidth=10)):this.config.annotTracksHeight=0;this.config.chrMargin=this.config.chrMargin+this.config.chrWidth+2*this.config.annotTracksHeight;c.onLoad&&(this.onLoadCallback=c.onLoad);c.onDrawAnnots&&(this.onDrawAnnotsCallback=c.onDrawAnnots);c.onBrushMove&&(this.onBrushMoveCallback=c.onBrushMove);this.coordinateSystem=
"iscn";this.maxLength={bp:0,iscn:0};this.organisms={9606:{commonName:"Human",scientificName:"Homo sapiens",scientificNameAbbr:"H. sapiens"},10090:{commonName:"Mouse",scientificName:"Mus musculus",scientificNameAbbr:"M. musculus"}};this.config.annotationsPath&&!this.config.annotationHeight&&(this.config.annotationHeight=3);this.chromosomesArray=[];this.bandsToShow=[];this.chromosomes={};this.bandData={};this.init()};
Ideogram.prototype.getBands=function(c,d,b){var a=[],e,f,k,g;"undefined"===typeof chrBands?(delimiter=/\t/,c=c.split(/\r\n|\n/),k=1):(delimiter=/ /,k=0);for(g=c.length;k<g;k++)e=c[k].split(delimiter),e[0]===d&&(f=e[7],e[8]&&(f+=e[8]),e={chr:e[0],bp:{start:parseInt(e[5],10),stop:parseInt(e[6],10)},iscn:{start:parseInt(e[3],10),stop:parseInt(e[4],10)},px:{start:-1,stop:-1,width:-1},name:e[1]+e[2],stain:f,taxid:b},a.push(e));return a};
Ideogram.prototype.getChromosomeModel=function(c,d,b,a){var e={},f=this.config.chrHeight,k=this.maxLength,g;g=this.coordinateSystem;e.chrIndex=a;e.name=d;!0===this.config.fullChromosomeLabels&&(e.name=this.organisms[b].scientificNameAbbr+" chr"+e.name);e.id="chr"+d+"-"+b;e.length=c[c.length-1][g].stop;a=e.length;for(var h=pxStop=0;h<c.length;h++)d=c[h],b=f*e.length/k[g]*(d[g].stop-d[g].start)/a,c[h].px={start:pxStop,stop:pxStop+b,width:b},pxStop=c[h].px.stop,"acen"===d.stain&&"p"===d.name[0]&&(e.pcenIndex=
h);e.width=pxStop;e.scale={};!0===this.config.multiorganism?(e.scale.bp=1,e.scale.iscn=f*a/k.bp):(e.scale.bp=f/k.bp,e.scale.iscn=f/k.iscn);e.bands=c;e.centromerePosition="";1==c[0].bp.stop-c[0].bp.start&&(e.centromerePosition="telocentric",e.bands=e.bands.slice(1));return e};
Ideogram.prototype.drawChromosomeLabels=function(c){var d,b,a,e,f;b=[];for(a in c)for(d in c[a])b.push(c[a][d]);e=this;f=e.config.chrMargin-e.config.chrWidth-2;"vertical"===e.config.orientation&&!0===e.config.showBandLabels&&(f=e.config.chrMargin+8);"vertical"===e.config.orientation?d3.selectAll(".chromosome").append("text").data(b).attr("class","chrLabel").attr("transform","rotate(-90)").attr("y",-16).each(function(b,a){var c,d;c=b.name.split(" ");var l=[];if(void 0!=c)for(l.push(c.slice(0,c.length-
1).join(" ")),l.push(c[c.length-1]),e.config.showBandLabels||(a+=1),c=e.config.chrMargin*a,c=-(c+f)+3+2*e.config.annotTracksHeight,a=0;a<l.length;a++)d="",0==a&&e.config.fullChromosomeLabels&&(d="italic"),d3.select(this).append("tspan").text(l[a]).attr("dy",a?"1.2em":0).attr("x",c).attr("text-anchor","middle").attr("class",d)}):d3.selectAll(".chromosome").append("text").data(b).attr("class","chrLabel").attr("x",-5).each(function(a,b){var c,d;c=a.name.split(" ");var l=[];if(void 0!=c)for(l.push(c.slice(0,
c.length-1).join(" ")),l.push(c[c.length-1]),c=e.config.chrMargin*b,c=c+f+9,b=0;b<l.length;b++)d="",0==b&&e.config.fullChromosomeLabels&&(d="italic"),d3.select(this).append("tspan").text(l[b]).attr("dy",b?"1.2em":0).attr("y",c).attr("x",-8).attr("text-anchor","middle").attr("class",d)})};
Ideogram.prototype.drawBandLabels=function(c){var d,b,a;b=[];for(a in c)for(d in c[a])b.push(c[a][d]);var e={};for(c=chrIndex=0;c<b.length;c++){chrIndex+=1;chrModel=b[c];d=d3.select("#"+chrModel.id);var f=this.config.chrMargin*chrIndex,k;k=f;1==chrIndex&&"perspective"in this.config&&"comparative"==this.config.perspective&&(k+=18);e[chrModel.id]=[];d.selectAll("text").data(chrModel.bands).enter().append("g").attr("class",function(a,b){return"bandLabel bsbsl-"+b}).attr("transform",function(a){a=-8+
a.px.start+a.px.width/2;e[chrModel.id].push(a+13);return"translate("+a+","+(f-10)+")"}).append("text").text(function(a){return a.name});d.selectAll("line.bandLabelStalk").data(chrModel.bands).enter().append("g").attr("class",function(a,b){return"bandLabelStalk bsbsl-"+b}).attr("transform",function(a){return"translate("+(a.px.start+a.px.width/2)+", "+k+")"}).append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",-8)}for(c=0;c<b.length;c++){chrModel=b[c];var g=e[chrModel.id].length,h;a=[];
var m,l,n;for(d=h=0;d<g;d++)l=e[chrModel.id][d],!1===l<h+5?(a.push(d),m!==d&&(prevTextBoxLeft=e[chrModel.id][d],prevTextBoxWidth=36,n=prevTextBoxLeft+prevTextBoxWidth),l<n+5?(m=d,h=n):a.push(d)):(m=d,h=n);g=[];h=a.length;for(l=0;l<h;l++)d=a[l],g.push("#"+chrModel.id+" .bsbsl-"+d);this.bandsToShow=this.bandsToShow.concat(g)}};
Ideogram.prototype.rotateChromosomeLabels=function(c,d,b,a){var e,f,k,g,h,m,l;f=this.config.chrWidth;e=this.config.chrMargin*d;m=this.config.numAnnotTracks;k=this;"undefined"===typeof a||!a.hasOwnProperty("x")||1==a.x&&1==a.y?(g=-8,h=-16,a={x:1,y:1},l=""):(l="scale("+a.x+","+a.y+")",g=-6,h=""===a?-16:-14);"vertical"==b||""==b?c.selectAll("text.chrLabel").attr("transform",l).selectAll("tspan").attr("x",g).attr("y",function(a,c){var e=d-1;(1<m||""==b)&&--e;chrMargin2=-4;!0===k.config.showBandLabels&&
(chrMargin2=k.config.chrMargin+f+26);e*=k.config.chrMargin;0==1<m&&(e+=1);return e+chrMargin2}):(--d,chrMargin2=-f-2,!0===k.config.showBandLabels&&(chrMargin2=k.config.chrMargin+8),c.selectAll("text.chrLabel").attr("transform","rotate(-90)"+l).selectAll("tspan").attr("x",function(b,c){e=k.config.chrMargin*d;g=-(e+chrMargin2)+3+2*k.config.annotTracksHeight;return g/=a.x}).attr("y",h))};
Ideogram.prototype.rotateBandLabels=function(c,d,b){var a,e,f,k;k=c.selectAll(".bandLabel");a=this.config.chrMargin*d;f=c.attr("data-orientation");"undefined"==typeof b?(b={x:1,y:1},e=""):e="scale("+b.x+","+b.y+")";1==d&&"perspective"in this.config&&"comparative"==this.config.perspective?k.attr("transform",function(b){return"rotate(-90)translate("+(8-a-26)+","+(2+b.px.start+b.px.width/2)+")"}).selectAll("text").attr("text-anchor","end"):"vertical"==f?k.attr("transform",function(b){return"rotate(-90)translate("+
(8-a)+","+(2+b.px.start+b.px.width/2)+")"}).selectAll("text").attr("transform",e):(k.attr("transform",function(c){return"translate("+(-8*b.x+c.px.start+c.px.width/2)+","+(a-10)+")"}).selectAll("text").attr("transform",e),c.selectAll(".bandLabelStalk line").attr("transform",e))};
Ideogram.prototype.drawChromosome=function(c,d){var b,a,e,f,k,g,h,m;m=this;h=m.bump;g="telocentric"!=c.centromerePosition?h:Math.round(h/4)+3;b=d3.select("svg").append("g").attr("id",c.id).attr("class","chromosome");a=m.config.chrWidth;e=c.width;var l=m.config.chrMargin*d;b.selectAll("path").data(c.bands).enter().append("path").attr("id",function(a){a=a.name.replace(".","-");return c.id+"-"+a}).attr("class",function(a){var b="band "+a.stain;"acen"==a.stain&&(b+=" "+a.name[0]+"-cen");return b}).attr("d",
function(b,e){var f=b.px.width,d=b.px.start;"acen"==b.stain?(f-=h/2,b="p"==b.name[0]?"M "+d+" "+l+" l "+f+" 0 q "+h+" "+a/2+" 0 "+a+" l -"+f+" 0 z":"M "+(d+f+h/2)+" "+l+" l -"+f+" 0 q -"+(h+.5)+" "+a/2+" 0 "+a+" l "+f+" 0 z"):(0==e&&(d+=g-h/2,!0===m.config.multiorganism&&(d+=g)),e==c.bands.length-1&&(d-=g-h/2),b="M "+d+" "+l+" l "+f+" 0 l 0 "+a+" l -"+f+" 0 z");return b});"telocentric"!=c.centromerePosition?b.append("path").attr("class","p-ter chromosomeBorder "+c.bands[0].stain).attr("d","M "+(g-
h/2+.1)+" "+l+" q -"+g+" "+a/2+" 0 "+a):(b.append("path").attr("class","p-ter chromosomeBorder "+c.bands[0].stain).attr("d","M "+(g-3)+" "+l+" l -"+(g-2)+" 0 l 0 "+a+" l "+(g-2)+" 0 z"),b.insert("path",":first-child").attr("class","acen").attr("d","M "+(g-3)+" "+(l+.1*a)+" l "+(g+h/2+1)+" 0 l 0 "+.8*a+" l -"+(g+h/2+1)+" 0 z"));b.append("path").attr("class","q-ter chromosomeBorder "+c.bands[c.bands.length-1].stain).attr("d","M "+(e-h/2-.6)+" "+l+" q "+h+" "+a/2+" 0 "+a);e=c.pcenIndex;k=c.bands[e];
f=c.bands[e+1];0<e?(e=k.px.start,f=f.px.stop):(e=2,f=document.querySelectorAll("#"+c.id+" .band")[0].getBBox().x);k=c.width-f;b.append("line").attr("class","cb-p-arm-top chromosomeBorder").attr("x1",h/2).attr("y1",l).attr("x2",e).attr("y2",l);b.append("line").attr("class","cb-p-arm-bottom chromosomeBorder").attr("x1",h/2).attr("y1",a+l).attr("x2",e).attr("y2",a+l);b.append("line").attr("class","cb-q-arm-top chromosomeBorder").attr("x1",f).attr("y1",l).attr("x2",f+k-h/2-.5).attr("y2",l);b.append("line").attr("class",
"cb-q-arm-bottom chromosomeBorder").attr("x1",f).attr("y1",a+l).attr("x2",f+k-h/2-.5).attr("y2",a+l)};Ideogram.prototype.initTransformChromosome=function(c,d){if("vertical"==this.config.orientation){var b,a;a=this.config.chrWidth;b=this.config.chrMargin*d;this.config.showBandLabels||(d+=2);b+=(a-4)*(d-1);c.attr("data-orientation","vertical").attr("transform","rotate(90, "+(b-30)+", "+b+")");this.rotateBandLabels(c,d)}else c.attr("data-orientation","horizontal")};
Ideogram.prototype.rotateAndToggleDisplay=function(c){var d,b,a,e,f,k,g,h,m=this;d=d3.select("#"+c);b=m.chromosomes[m.config.taxid][c.split("-")[0].split("chr")[1]].chrIndex;otherChrs=d3.selectAll("g.chromosome").filter(function(a,b){return this.id!==c});g=m.config.orientation;h=d.attr("data-orientation");a=this.config.chrMargin*b;e=this.config.chrWidth;f=d3.select("#ideogram")[0][0].getBoundingClientRect();k=f.height;f=f.width;"vertical"==g?(chrLength=d[0][0].getBoundingClientRect().height,f=f/chrLength*
.99,k=1.5,scale="scale("+f+", "+k+")",inverseScaleX=2/f,inverseScaleY=1,this.config.showBandLabels||(b+=2),e=a+(e-4)*(b-1)-30,verticalTransform="rotate(90, "+e+", "+(e+30)+")",a=-1*(a-this.config.annotTracksHeight)*k,this.config.showBandLabels&&(a+=25),horizontalTransform="rotate(0)translate(20, "+a+")"+scale):(chrLength=d[0][0].getBoundingClientRect().width,f=k/chrLength*.99,scale="scale("+f+", 1.5)",inverseScaleX=2/f,inverseScaleY=1,k=20,this.config.showBandLabels||(b+=2,k=15),e=a+(e-k)*(b-2),a=
e+5,this.config.showBandLabels||(e+=k,a+=k),verticalTransform="rotate(90, "+e+", "+a+")"+scale,horizontalTransform="");inverseScale="scale("+inverseScaleX+","+inverseScaleY+")";"vertical"!=h?("horizontal"==g&&otherChrs.style("display","none"),d.selectAll(".annot>path").attr("transform","vertical"==g?"":inverseScale),d.attr("data-orientation","vertical").transition().attr("transform",verticalTransform).each("end",function(){scale="vertical"==g?"":{x:inverseScaleY,y:inverseScaleX};m.rotateBandLabels(d,
b,scale);m.rotateChromosomeLabels(d,b,"horizontal",scale);"vertical"==g&&otherChrs.style("display","")})):(d.attr("data-orientation",""),"vertical"==g&&otherChrs.style("display","none"),d.selectAll(".annot>path").transition().attr("transform","vertical"==g?inverseScale:""),d.transition().attr("transform",horizontalTransform).each("end",function(){inverseScale="horizontal"==g?"vertical"==h?{x:1,y:1}:"":{x:inverseScaleX,y:inverseScaleY};m.rotateBandLabels(d,b,inverseScale);m.rotateChromosomeLabels(d,
b,"",inverseScale);"horizontal"==g&&otherChrs.style("display","")}))};Ideogram.prototype.convertBpToPx=function(c,d){var b,a;for(b=0;b<c.bands.length;b++)if(a=c.bands[b],d>=a.bp.start&&d<=a.bp.stop)return b=(a.iscn.stop-a.iscn.start)/(a.bp.stop-a.bp.start),b=a.iscn.start+(d-a.bp.start)*b,a=30+a.px.start+a.px.width*(b-a.iscn.start)/(a.iscn.stop-a.iscn.start);throw Error("Base pair out of range.  bp: "+d+"; length of chr"+c.name+": "+a.bp.stop);};
Ideogram.prototype.convertPxToBp=function(c,d){var b,a;for(b=0;b<c.bands.length;b++)if(a=c.bands[b],d>=a.px.start&&d<=a.px.stop)return pxToIscnScale=(a.iscn.stop-a.iscn.start)/(a.px.stop-a.px.start),b=a.iscn.start+(d-a.px.start)*pxToIscnScale,bp=a.bp.start+(a.bp.stop-a.bp.start)*(b-a.iscn.start)/(a.iscn.stop-a.iscn.start),Math.round(bp);throw Error("Pixel out of range.  px: "+bp+"; length of chr"+c.name+": "+a.px.stop);};
Ideogram.prototype.drawSynteny=function(c){var d=(new Date).getTime(),b,a,e,f,k,g,h,m,l;k=d3.select("svg").append("g").attr("class","synteny");for(g=0;g<c.length;g++)regions=c[g],b=regions.r1,a=regions.r2,h="#CFC","color"in regions&&(h=regions.color),m=1,"opacity"in regions&&(m=regions.opacity),b.startPx=this.convertBpToPx(b.chr,b.start),b.stopPx=this.convertBpToPx(b.chr,b.stop),a.startPx=this.convertBpToPx(a.chr,a.start),a.stopPx=this.convertBpToPx(a.chr,a.stop),e=document.querySelectorAll("#"+b.chr.id+
" path")[0].getBBox(),f=document.querySelectorAll("#"+a.chr.id+" path")[0].getBBox(),e=e.y-30,f=f.y-29,l=b.chr.id+"_"+b.start+"_"+b.stop+"___"+a.chr.id+"_"+a.start+"_"+a.stop,syntenicRegion=k.append("g").attr("class","syntenicRegion").attr("id",l).on("click",function(){var a=this,b=d3.selectAll(".syntenicRegion").filter(function(b,c){return this!==a});b.classed("hidden",!b.classed("hidden"))}).on("mouseover",function(){var b=this;d3.selectAll(".syntenicRegion").filter(function(a,c){return this!==
b}).classed("ghost",!0)}).on("mouseout",function(){d3.selectAll(".syntenicRegion").classed("ghost",!1)}),syntenicRegion.append("polygon").attr("points",e+", "+b.startPx+" "+e+", "+b.stopPx+" "+f+", "+a.stopPx+" "+f+", "+a.startPx).attr("style","fill: "+h+"; fill-opacity: "+m),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",e).attr("x2",f).attr("y1",b.startPx).attr("y2",a.startPx),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",e).attr("x2",f).attr("y1",
b.stopPx).attr("y2",a.stopPx);c=(new Date).getTime();this.debug&&console.log("Time in drawSyntenicRegions: "+(c-d)+" ms")};
Ideogram.prototype.processAnnotData=function(c){var d,b,a,e,f,k,g,h;e=[];for(d=0;d<c.length;d++)for(annotsByChr=c[d],e.push({chr:annotsByChr.chr,annots:[]}),b=0;b<annotsByChr.annots.length;b++)f=annotsByChr.chr,ra=annotsByChr.annots[b],a=ra[1],k=ra[2],g=this.chromosomes["9606"][f],f=this.convertBpToPx(g,a),g=this.convertBpToPx(g,k),f=Math.round((f+g)/2)-28,h="#F00",this.config.annotationTracks?(g=ra[3],h=this.config.annotationTracks[g].color):g=0,a={id:ra[0],chrIndex:d,start:a,stop:k,px:f,color:h,
trackIndex:g},e[d].annots.push(a);return e};
Ideogram.prototype.getHistogramBars=function(c){var d=(new Date).getTime(),b,a,e,f,k,g,h,m,l;h=[];a=this.config.barWidth;f=this.chromosomes[this.config.taxid];for(e in f){chrModel=f[e];chrIndex=chrModel.chrIndex;lastBand=chrModel.bands[chrModel.bands.length-1];b=lastBand.px.stop;numBins=Math.round(b/a);g={chr:e,annots:[]};for(b=0;b<numBins;b++)k=b*a-this.bump,bp=this.convertPxToBp(chrModel,k+this.bump),g.annots.push({bp:bp,px:k,count:0,chrIndex:chrIndex,color:"#F00"});h.push(g)}for(e in c)for(g=c[e].annots,
chrName=c[e].chr,chrModel=f[chrName],chrIndex=chrModel.chrIndex,barAnnots=h[chrIndex-1].annots,b=0;b<g.length;b++)for(k=g[b],k=k.px,a=0;a<barAnnots.length-1;a++)if(m=barAnnots[a].px,l=barAnnots[a+1].px,k>m&&k<l){h[chrIndex-1].annots[a].count+=1;break}for(b=e=0;b<h.length;b++)for(c=h[b].annots,a=0;a<c.length;a++)barCount=c[a].count,barCount>e&&(e=barCount);for(b=0;b<h.length;b++)for(c=h[b].annots,a=0;a<c.length;a++)barCount=c[a].count,height=barCount/e*this.config.chrMargin,h[b].annots[a].height=height;
c=(new Date).getTime();this.debug&&console.log("Time spent in getHistogramBars: "+(c-d)+" ms");return h};
Ideogram.prototype.drawAnnots=function(c){var d,b,a,e,f,k,g,h,m,l=this;d=this.config.chrMargin;b=this.config.chrWidth;a="tracks";this.config.annotationsLayout&&(a=this.config.annotationsLayout);"histogram"===a&&(c=l.getHistogramBars(c));e=this.config.annotationHeight;f="l -"+e+" "+2*e+" l "+2*e+" 0 z";c=d3.selectAll(".chromosome").data(c).selectAll("path.annot").data(function(b){return b.annots}).enter();"tracks"===a?c.append("g").attr("id",function(b,a){return b.id}).attr("class","annot").attr("transform",
function(a){return"translate("+a.px+","+((a.chrIndex+1)*d+b+a.trackIndex*e*2)+")"}).append("path").attr("d","m0,0"+f).attr("fill",function(b){return b.color}):"overlay"===a?c.append("polygon").attr("id",function(b,a){return b.id}).attr("class","annot").attr("points",function(a){k=a.px-.5;g=a.px+.5;h=(a.chrIndex+1)*d+b;m=(a.chrIndex+1)*d;return k+","+h+" "+g+","+h+" "+g+","+m+" "+k+","+m}).attr("fill",function(a){return a.color}):"histogram"===a&&c.append("polygon").attr("class","annot").attr("points",
function(a){k=a.px+l.bump;g=a.px+l.config.barWidth+l.bump;h=a.chrIndex*d+b;m=a.chrIndex*d+b+a.height;a=l.chromosomesArray[a.chrIndex-1].width;g>a&&(g=a);return k+","+h+" "+g+","+h+" "+g+","+m+" "+k+","+m}).attr("fill",function(a){return a.color});if(l.onDrawAnnotsCallback)l.onDrawAnnotsCallback()};
Ideogram.prototype.putChromosomesInRows=function(){var c=this.config.rows,d,b,a,e,f,k;d=Math.floor(this.config.chromosomes[this.config.taxid].length/c);e=0;"g"!==d3.select("svg > *")[0][0].tagName&&(e=2);for(var g=1;g<c;g++)b=d*g+1+e,a=b+d,range="nth-child(n+"+b+"):nth-child(-n+"+a+")",f=this.config.chrHeight+20,b=b+1-e,a=this.config.chrWidth,k=this.config.chrMargin*b,this.config.showBandLabels||(b+=2),this.config.showChromosomeLabels&&(f+=12),rowWidth=k+(a-4)*b+8,d3.selectAll("#ideogram .chromosome:"+
range).attr("transform",function(a,b){return d3.select(this).attr("transform")+("translate("+f+", "+rowWidth+")")})};Ideogram.prototype.onBrushMove=function(){call(this.onBrushMoveCallback)};
Ideogram.prototype.createBrush=function(c,d){var b=this,a=b.config.chrWidth+6.5,e=b.chromosomesArray[0],f=e.bands[e.bands.length-1].bp.stop,k,g;g=[0];k=[0];for(var h,m=0;m<e.bands.length;m++)h=e.bands[m],g.push(h.bp.stop),k.push(h.px.stop);e=d3.scale.linear().domain(g).range(k);g=d3.select(".band")[0][0].getBBox().y-3.25;"undefined"===typeof c&&(c=Math.floor(f/10));"undefined"===typeof right&&(d=Math.ceil(2*c));f=c;k=d;b.selectedRegion={from:c,to:d,extent:d-c};b.brush=d3.svg.brush().x(e).extent([f,
k]).on("brush",function(){var a=b.brush.extent(),c=Math.floor(a[0]),a=Math.ceil(a[1]);b.selectedRegion={from:c,to:a,extent:a-c};if(b.onBrushMove)b.onBrushMoveCallback()});d3.select("#ideogram").append("g").attr("class","brush").attr("transform","translate(0, "+g+")").call(b.brush).selectAll("rect").attr("height",a)};Ideogram.prototype.onLoad=function(){call(this.onLoadCallback)};Ideogram.prototype.onDrawAnnots=function(){call(this.onDrawAnnotsCallback)};
Ideogram.prototype.getBandColorGradients=function(){var c,d,b="";c=[["gneg","#FFF","#FFF","#DDD"],["gpos25","#C8C8C8","#DDD","#BBB"],["gpos33","#BBB","#BBB","#AAA"],["gpos50","#999","#AAA","#888"],["gpos66","#888","#888","#666"],["gpos75","#777","#777","#444"],["gpos100","#444","#666","#000"],["acen","#FEE","#FEE","#FDD"]];for(var a=0;a<c.length;a++)d=c[a][0],color1=c[a][1],color2=c[a][2],color3=c[a][3],b+='<linearGradient id="'+d+'" x1="0%" y1="0%" x2="0%" y2="100%">',b="gneg"==d?b+('<stop offset="70%" stop-color="'+
color2+'" /><stop offset="95%" stop-color="'+color3+'" /><stop offset="100%" stop-color="'+color1+'" />'):b+('<stop offset="5%" stop-color="'+color1+'" /><stop offset="15%" stop-color="'+color2+'" /><stop offset="60%" stop-color="'+color3+'" />'),b+="</linearGradient>";b="<defs>"+(b+'<pattern id="stalk" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#CCE" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#88B; stroke-width:0.7;" /></pattern><pattern id="gvar" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(-30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#DDF" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#99C; stroke-width:0.7;" /></pattern>')+
"</defs>";css='<style>.gneg {fill: url("#gneg")} .gpos25 {fill: url("#gpos25")} .gpos33 {fill: url("#gpos33")} .gpos50 {fill: url("#gpos50")} .gpos66 {fill: url("#gpos66")} .gpos75 {fill: url("#gpos75")} .gpos100 {fill: url("#gpos100")} .acen {fill: url("#acen")} .stalk {fill: url("#stalk")} .gvar {fill: url("#gvar")} </style>';return b=css+b};
Ideogram.prototype.init=function(){function c(){var a,c,d,g,h,l=f.config.taxids;m=[];var p=(new Date).getTime();for(d=0;d<l.length;d++)for(b=l[d],h=f.bandData[b],e=f.config.chromosomes[b],g=0;g<e.length;g++)a=e[g],c=f.getBands(h,a,b),m.push(c),a=c[c.length-1].iscn.stop,c=c[c.length-1].bp.stop,a>f.maxLength.iscn&&(f.maxLength.iscn=a),c>f.maxLength.bp&&(f.maxLength.bp=c);d=(new Date).getTime();this.debug&&console.log("Time in getBands: "+(d-p)+" ms");h=0;p=(new Date).getTime();for(d=0;d<l.length;d++){b=
l[d];e=f.config.chromosomes[b];f.chromosomes[b]={};for(g=0;g<e.length;g++)c=m[h],h+=1,a=e[g],c=f.getChromosomeModel(c,a,b,h),f.chromosomes[b][a]=c,f.chromosomesArray.push(c),f.drawChromosome(c,h);!0===f.config.showBandLabels&&f.drawBandLabels(f.chromosomes)}for(d=h=0;d<l.length;d++)for(b=l[d],e=f.config.chromosomes[b],g=0;g<e.length;g++)h+=1,a=e[g],chrModel=f.chromosomes[b][a],chr=d3.select("#chr"+a+"-"+b),f.initTransformChromosome(chr,h);if(f.config.annotationsPath){var q=function(){"undefined"!==
typeof timeout&&window.clearTimeout(timeout);f.annots=f.processAnnotData(f.rawAnnots);f.drawAnnots(f.annots)};f.rawAnnots?q():function r(){timeout=setTimeout(function(){f.rawAnnots?q():r()},50)}()}if(!0===f.config.showBandLabels&&(d=f.bandsToShow.join(","),l=(new Date).getTime(),d3.selectAll(".bandLabel, .bandLabelStalk").style("display","none"),d3.selectAll(d).style("display",""),d=(new Date).getTime(),this.debug&&console.log("Time in showing bands: "+(d-l)+" ms"),"vertical"===f.config.orientation))for(l=
0;l<f.chromosomesArray.length;l++)f.rotateChromosomeLabels(d3.select("#"+f.chromosomesArray[l].id),l);!0===f.config.showChromosomeLabels&&f.drawChromosomeLabels(f.chromosomes);1<f.config.rows&&f.putChromosomesInRows();!0===f.config.brush&&f.createBrush();l=(new Date).getTime();this.debug&&console.log("Time in drawChromosome: "+(l-p)+" ms");l=(new Date).getTime();this.debug&&console.log("Time constructing ideogram: "+(l-k)+" ms");if(f.onLoadCallback)f.onLoadCallback()}var d=!0===this.config.multiorganism,
b,a,e,f=this,k=(new Date).getTime();if(0==d)"undefined"==typeof this.config.taxid&&(this.config.taxid="9606"),b=this.config.taxid,a=[b],this.config.taxids=a,e=this.config.chromosomes.slice(),this.config.chromosomes={},this.config.chromosomes[b]=e;else for(this.coordinateSystem="bp",a=this.config.taxids,d=0;d<a.length;d++)b=a[d];this.config.annotationsPath&&d3.json(f.config.annotationsPath,function(a){f.rawAnnots=a.annots});d="";this.config.showChromosomeLabels&&(d="horizontal"==this.config.orientation?
d+"labeledLeft ":d+"labeled ");this.config.annotationsLayout&&"overlay"===this.config.annotationsLayout&&(d+="faint");var g=this.config.chrHeight+40;1<this.config.rows&&(g=this.config.rows*(g-40));var h=this.getBandColorGradients();d3.select(this.config.container).append("svg").attr("id","ideogram").attr("class",d).attr("width","97%").attr("height",g).html(h);for(var m=[],l=0,g=this.config.resolution,d=0;d<a.length;d++)b=a[d],bandDataFileNames={9606:"ideogram_9606_GCF_000001305.14_"+g+"_V1",10090:"ideogram_10090_GCF_000000055.19_NA_V2"},
"undefined"===typeof chrBands?d3.xhr("../data/bands/ncbi/"+bandDataFileNames[b]).on("beforesend",function(a){a.taxid=b}).get(function(b,d){f.bandData[d.taxid]=d.response;l+=1;l==a.length&&c()}):(f.bandData["9606"]=chrBands,c())};
//# sourceMappingURL=ideogram.js.map
