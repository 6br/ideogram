var Ideogram=function(c){this.config=JSON.parse(JSON.stringify(c));this.debug=!1;this.config.bandDir||(this.config.bandDir="../data/bands/");this.config.container||(this.config.container="body");this.config.resolution||(this.config.resolution=850);!1==="showChromosomeLabels"in this.config&&(this.config.showChromosomeLabels=!0);this.config.chrMargin||(this.config.chrMargin=10);this.config.chrWidth||(this.config.chrWidth=10);this.config.orientation||(this.config.orientation="vertical");this.config.showBandLabels||
(this.config.showBandLabels=!1);this.config.brush||(this.config.brush=!1);this.config.rows||(this.config.rows=1);!1==="chrHeight"in c&&(c.chrHeight=500);this.bump=Math.round(c.chrHeight/125);this.adjustedBump=!1;200>c.chrHeight&&(this.adjustedBump=!0,this.bump=4);c.showBandLabels&&(this.config.chrMargin+=20);this.config.annotationsPath||this.config.localAnnotationsPath?(this.config.annotationHeight||(this.config.annotationHeight=3),this.config.numAnnotTracks=this.config.annotationTracks?this.config.annotationTracks.length:
1,this.config.annotTracksHeight=this.config.annotationHeight*this.config.numAnnotTracks,"undefined"===typeof this.config.barWidth&&(this.config.barWidth=3),"undefined"===typeof this.config.annotationsColor&&(this.config.annotationsColor="#F00")):this.config.annotTracksHeight=0;this.config.chrMargin=this.config.chrMargin+this.config.chrWidth+2*this.config.annotTracksHeight;c.onLoad&&(this.onLoadCallback=c.onLoad);c.onDrawAnnots&&(this.onDrawAnnotsCallback=c.onDrawAnnots);c.onBrushMove&&(this.onBrushMoveCallback=
c.onBrushMove);this.coordinateSystem="iscn";this.maxLength={bp:0,iscn:0};this.organisms={9606:{commonName:"Human",scientificName:"Homo sapiens",scientificNameAbbr:"H. sapiens",assemblies:{"default":"GCF_000001305.14",GRCh38:"GCF_000001305.14",GRCh37:"GCF_000001305.13"}},10090:{commonName:"Mouse",scientificName:"Mus musculus",scientificNameAbbr:"M. musculus",assemblies:{"default":"GCF_000000055.19"}},7227:{commonName:"Fly",scientificName:"Drosophlia melanogaster",scientificNameAbbr:"D. melanogaster"}};
this.config.annotationsPath&&!this.config.annotationHeight&&(this.config.annotationHeight=3);this.chromosomesArray=[];this.bandsToShow=[];this.chromosomes={};this.numChromosomes=0;this.bandData={};this.init()};
Ideogram.prototype.getBands=function(c,f,d){var a={},b,k,h,g,e,l;"chrBands"===c.slice(0,8)&&(b="native");"undefined"===typeof chrBands&&"native"!==b?(delimiter=/\t/,c=c.split(/\r\n|\n/),g=1):(delimiter=/ /,c="native"===b?eval(c):c,g=0);e=c[0].split(delimiter)[0];b="#chromosome"==e?"ncbi":"#chrom"==e?"ucsc":"native";e=c.length;if("ncbi"===b||"native"===b)for(;g<e;g++){if(b=c[g].split(delimiter),h=b[0],"undefined"===typeof d||-1!==d.indexOf(h))!1===h in a&&(a[h]=[]),k=b[7],b[8]&&(k+=b[8]),b={chr:h,
bp:{start:parseInt(b[5],10),stop:parseInt(b[6],10)},iscn:{start:parseInt(b[3],10),stop:parseInt(b[4],10)},px:{start:-1,stop:-1,width:-1},name:b[1]+b[2],stain:k,taxid:f},a[h].push(b)}else if("ucsc"===b)for(;g<e;g++)b=c[g].split(delimiter),b[0]==="chr"+chromosomeName&&(k=b[4],"n/a"===k&&(k="gpos100"),d=parseInt(b[1],10),l=parseInt(b[2],10),b={chr:b[0].split("chr")[1],bp:{start:d,stop:l},iscn:{start:d,stop:l},px:{start:-1,stop:-1,width:-1},name:b[3],stain:k,taxid:f},a[h].push(b));return a};
Ideogram.prototype.getChromosomeModel=function(c,f,d,a){var b={},k=this.config.chrHeight,h=this.maxLength,g;g=this.coordinateSystem;b.chrIndex=a;b.name=f;!0===this.config.fullChromosomeLabels&&(b.name=this.organisms[d].scientificNameAbbr+" chr"+b.name);b.id="chr"+f+"-"+d;b.length=c[c.length-1][g].stop;a=b.length;for(var e=pxStop=0;e<c.length;e++)f=c[e],d=k*b.length/h[g]*(f[g].stop-f[g].start)/a,c[e].px={start:pxStop,stop:pxStop+d,width:d},pxStop=c[e].px.stop,"acen"===f.stain&&"p"===f.name[0]&&(b.pcenIndex=
e);b.width=pxStop;b.scale={};!0===this.config.multiorganism?(b.scale.bp=1,b.scale.iscn=k*a/h.bp):(b.scale.bp=k/h.bp,b.scale.iscn=k/h.iscn);b.bands=c;b.centromerePosition="";1==c[0].bp.stop-c[0].bp.start&&(b.centromerePosition="telocentric",b.bands=b.bands.slice(1));return b};
Ideogram.prototype.drawChromosomeLabels=function(c){var f,d;f=this;c=f.chromosomesArray;d=f.config.chrMargin-f.config.chrWidth-2;"vertical"===f.config.orientation&&!0===f.config.showBandLabels&&(d=f.config.chrMargin+8);"vertical"===f.config.orientation?d3.selectAll(".chromosome").append("text").data(c).attr("class","chrLabel").attr("transform","rotate(-90)").attr("y",-16).each(function(a,b){var c,h;c=a.name.split(" ");var g=[];if(void 0!=c)for(g.push(c.slice(0,c.length-1).join(" ")),g.push(c[c.length-
1]),f.config.showBandLabels||(b+=1),c=f.config.chrMargin*b,c=-(c+d)+3+2*f.config.annotTracksHeight,b=0;b<g.length;b++)h="",0==b&&f.config.fullChromosomeLabels&&(h="italic"),d3.select(this).append("tspan").text(g[b]).attr("dy",b?"1.2em":0).attr("x",c).attr("text-anchor","middle").attr("class",h)}):d3.selectAll(".chromosome").append("text").data(c).attr("class","chrLabel").attr("x",-5).each(function(a,b){var c,h;c=a.name.split(" ");var g=[];if(void 0!=c)for(g.push(c.slice(0,c.length-1).join(" ")),g.push(c[c.length-
1]),c=f.config.chrMargin*b,c=c+d+9,b=0;b<g.length;b++)h="",0==b&&f.config.fullChromosomeLabels&&(h="italic"),d3.select(this).append("tspan").text(g[b]).attr("dy",b?"1.2em":0).attr("y",c).attr("x",-8).attr("text-anchor","middle").attr("class",h)})};
Ideogram.prototype.drawBandLabels=function(c){var f,d,a,b;b=this;d=[];for(a in c)for(f in c[a])d.push(c[a][f]);var k={};for(c=chrIndex=0;c<d.length;c++){chrIndex+=1;chrModel=d[c];f=d3.select("#"+chrModel.id);var h=this.config.chrMargin*chrIndex,g;b=this;g=h;1==chrIndex&&"perspective"in this.config&&"comparative"==this.config.perspective&&(g+=18);k[chrModel.id]=[];f.selectAll("text").data(chrModel.bands).enter().append("g").attr("class",function(a,b){return"bandLabel bsbsl-"+b}).attr("transform",function(a){a=
b.round(-8+a.px.start+a.px.width/2);k[chrModel.id].push(a+13);return"translate("+a+","+(h-10)+")"}).append("text").text(function(a){return a.name});f.selectAll("line.bandLabelStalk").data(chrModel.bands).enter().append("g").attr("class",function(a,b){return"bandLabelStalk bsbsl-"+b}).attr("transform",function(a){return"translate("+b.round(a.px.start+a.px.width/2)+", "+g+")"}).append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",-8)}for(c=0;c<d.length;c++){chrModel=d[c];var e=k[chrModel.id].length,
l;a=[];var m,n,p;for(f=l=0;f<e;f++)n=k[chrModel.id][f],!1===n<l+5?(a.push(f),m!==f&&(prevTextBoxLeft=k[chrModel.id][f],prevTextBoxWidth=36,p=prevTextBoxLeft+prevTextBoxWidth),n<p+5?(m=f,l=p):a.push(f)):(m=f,l=p);e=[];l=a.length;for(n=0;n<l;n++)f=a[n],e.push("#"+chrModel.id+" .bsbsl-"+f);this.bandsToShow=this.bandsToShow.concat(e)}};
Ideogram.prototype.rotateChromosomeLabels=function(c,f,d,a){var b,k,h,g,e,l,m,n;k=this.config.chrWidth;b=this.config.chrMargin*f;l=this.config.numAnnotTracks;h=this;"undefined"===typeof a||!a.hasOwnProperty("x")||1==a.x&&1==a.y?(g=-8,e=-16,a={x:1,y:1},m=""):(m="scale("+a.x+","+a.y+")",g=-6,e=""===a?-16:-14);"vertical"==d||""==d?c.selectAll("text.chrLabel").attr("transform",m).selectAll("tspan").attr("x",g).attr("y",function(a,b){var c=f-1;(1<l||""==d)&&--c;chrMargin2=-4;!0===h.config.showBandLabels&&
(chrMargin2=h.config.chrMargin+k+26);c*=h.config.chrMargin;0==1<l&&(c+=1);return c+chrMargin2}):(--f,chrMargin2=-k-2,!0===h.config.showBandLabels&&(chrMargin2=h.config.chrMargin+8),n=h.config.annotTracksHeight,"overlay"!==h.config.annotationsLayout&&(n*=2),c.selectAll("text.chrLabel").attr("transform","rotate(-90)"+m).selectAll("tspan").attr("x",function(c,d){b=h.config.chrMargin*f;g=-(b+chrMargin2)+3+n;return g/=a.x}).attr("y",e))};
Ideogram.prototype.rotateBandLabels=function(c,f,d){var a,b,k,h,g=this;h=c.selectAll(".bandLabel");a=this.config.chrMargin*f;k=c.attr("data-orientation");"undefined"==typeof d?(d={x:1,y:1},b=""):b="scale("+d.x+","+d.y+")";1==f&&"perspective"in this.config&&"comparative"==this.config.perspective?h.attr("transform",function(b){var c;c=8-a-26;b=g.round(2+b.px.start+b.px.width/2);return"rotate(-90)translate("+c+","+b+")"}).selectAll("text").attr("text-anchor","end"):"vertical"==k?h.attr("transform",function(b){var c;
c=8-a;b=g.round(2+b.px.start+b.px.width/2);return"rotate(-90)translate("+c+","+b+")"}).selectAll("text").attr("transform",b):(h.attr("transform",function(b){return"translate("+g.round(-8*d.x+b.px.start+b.px.width/2)+","+(a-10)+")"}).selectAll("text").attr("transform",b),c.selectAll(".bandLabelStalk line").attr("transform",b))};Ideogram.prototype.round=function(c){return Math.round(100*c)/100};
Ideogram.prototype.drawChromosome=function(c,f){var d,a,b,k,h,g,e,l;e=this;g=e.bump;h="telocentric"!=c.centromerePosition?g:Math.round(g/4)+3;d=d3.select("svg").append("g").attr("id",c.id).attr("class","chromosome");a=e.config.chrWidth;var m=e.config.chrMargin*f;d.selectAll("path").data(c.bands).enter().append("path").attr("id",function(a){a=a.name.replace(".","-");return c.id+"-"+a}).attr("class",function(a){var b="band "+a.stain;"acen"==a.stain&&(b+=" "+a.name[0]+"-cen");return b}).attr("d",function(b,
d){var f=e.round(b.px.width),k=e.round(b.px.start),l,n,r;r=0;"acen"==b.stain?(e.adjustedBump?(r=.35,f=.2,k-=.1,"q"===b.name[0]&&(k+=1.2)):f-=g/2,l=m+r,n=a/2-2*r,r=a-2*r,"p"==b.name[0]?b="M "+k+" "+l+" l "+f+" 0 q "+g+" "+n+" 0 "+r+" l -"+f+" 0 z":(e.adjustedBump&&(f+=.2),b="M "+(k+f+g/2)+" "+l+" l -"+f+" 0 q -"+(g+.5)+" "+n+" 0 "+r+" l "+f+" 0 z")):(0==d&&(k+=h-g/2,!0===e.config.multiorganism&&(k+=h)),e.adjustedBump&&"q"===b.name[0]&&(k+=1.8),d==c.bands.length-1&&(k-=h-g/2),b="M "+k+" "+m+" l "+f+
" 0 l 0 "+a+" l -"+f+" 0 z");return b});"telocentric"!=c.centromerePosition?d.append("path").attr("class","p-ter chromosomeBorder "+c.bands[0].stain).attr("d","M "+(h-g/2+.1)+" "+m+" q -"+h+" "+a/2+" 0 "+a):(d.append("path").attr("class","p-ter chromosomeBorder "+c.bands[0].stain).attr("d","M "+(h-3)+" "+m+" l -"+(h-2)+" 0 l 0 "+a+" l "+(h-2)+" 0 z"),d.insert("path",":first-child").attr("class","acen").attr("d","M "+(h-3)+" "+(m+.1*a)+" l "+(h+g/2+1)+" 0 l 0 "+.8*a+" l -"+(h+g/2+1)+" 0 z"));l=e.adjustedBump?
1.8:0;b=c.pcenIndex;var n=c.bands[b];k=c.bands[b+1];0<b?(b=n.px.start,k=k.px.stop+l):(b=2,k=document.querySelectorAll("#"+c.id+" .band")[0].getBBox().x);l=k+(c.width-k+1.3*l)-g/2-.5;d.append("line").attr("class","cb-p-arm-top chromosomeBorder").attr("x1",g/2).attr("y1",m).attr("x2",b).attr("y2",m);d.append("line").attr("class","cb-p-arm-bottom chromosomeBorder").attr("x1",g/2).attr("y1",a+m).attr("x2",b).attr("y2",a+m);d.append("line").attr("class","cb-q-arm-top chromosomeBorder").attr("x1",k).attr("y1",
m).attr("x2",l).attr("y2",m);d.append("line").attr("class","cb-q-arm-bottom chromosomeBorder").attr("x1",k).attr("y1",a+m).attr("x2",l).attr("y2",a+m);d.append("path").attr("class","q-ter chromosomeBorder "+c.bands[c.bands.length-1].stain).attr("d","M "+l+" "+m+" q "+g+" "+a/2+" 0 "+a)};
Ideogram.prototype.initTransformChromosome=function(c,f){if("vertical"==this.config.orientation){var d,a;a=this.config.chrWidth;d=this.config.chrMargin*f;this.config.showBandLabels||(f+=2);d+=(a-4)*(f-1);c.attr("data-orientation","vertical").attr("transform","rotate(90, "+(d-30)+", "+d+")");this.rotateBandLabels(c,f)}else c.attr("data-orientation","horizontal")};
Ideogram.prototype.rotateAndToggleDisplay=function(c){var f,d,a,b,k,h,g,e,l=this;f=d3.select("#"+c);d=l.chromosomes[l.config.taxid][c.split("-")[0].split("chr")[1]].chrIndex;otherChrs=d3.selectAll("g.chromosome").filter(function(b,a){return this.id!==c});g=l.config.orientation;e=f.attr("data-orientation");a=this.config.chrMargin*d;b=this.config.chrWidth;k=d3.select("#ideogram")[0][0].getBoundingClientRect();h=k.height;k=k.width;"vertical"==g?(chrLength=f[0][0].getBoundingClientRect().height,h=k/chrLength*
.97,scale="scale("+h+", 1.5)",inverseScaleX=2/h,inverseScaleY=1,this.config.showBandLabels||(d+=2),b=a+(b-4)*(d-1)-30,verticalTransform="rotate(90, "+b+", "+(b+30)+")",a=-1.5*(a-this.config.annotTracksHeight),this.config.showBandLabels&&(a+=25),horizontalTransform="rotate(0)translate(20, "+a+")"+scale):(chrLength=f[0][0].getBoundingClientRect().width,h=h/chrLength*.97,scale="scale("+h+", 1.5)",inverseScaleX=2/h,inverseScaleY=1,h=20,this.config.showBandLabels||(d+=2,h=15),b=a+(b-h)*(d-2),a=b+5,this.config.showBandLabels||
(b+=h,a+=h),verticalTransform="rotate(90, "+b+", "+a+")"+scale,horizontalTransform="");inverseScale="scale("+inverseScaleX+","+inverseScaleY+")";"vertical"!=e?("horizontal"==g&&otherChrs.style("display","none"),f.selectAll(".annot>path").attr("transform","vertical"==g?"":inverseScale),f.attr("data-orientation","vertical").transition().attr("transform",verticalTransform).each("end",function(){scale="vertical"==g?"":{x:inverseScaleY,y:inverseScaleX};l.rotateBandLabels(f,d,scale);l.rotateChromosomeLabels(f,
d,"horizontal",scale);"vertical"==g&&otherChrs.style("display","")})):(f.attr("data-orientation",""),"vertical"==g&&otherChrs.style("display","none"),f.selectAll(".annot>path").transition().attr("transform","vertical"==g?inverseScale:""),f.transition().attr("transform",horizontalTransform).each("end",function(){inverseScale="horizontal"==g?"vertical"==e?{x:1,y:1}:"":{x:inverseScaleX,y:inverseScaleY};l.rotateBandLabels(f,d,inverseScale);l.rotateChromosomeLabels(f,d,"",inverseScale);"horizontal"==g&&
otherChrs.style("display","")}))};Ideogram.prototype.convertBpToPx=function(c,f){var d,a;for(d=0;d<c.bands.length;d++)if(a=c.bands[d],f>=a.bp.start&&f<=a.bp.stop)return d=(a.iscn.stop-a.iscn.start)/(a.bp.stop-a.bp.start),d=a.iscn.start+(f-a.bp.start)*d,a=30+a.px.start+a.px.width*(d-a.iscn.start)/(a.iscn.stop-a.iscn.start);throw Error("Base pair out of range.  bp: "+f+"; length of chr"+c.name+": "+a.bp.stop);};
Ideogram.prototype.convertPxToBp=function(c,f){var d,a;for(d=0;d<c.bands.length;d++)if(a=c.bands[d],f>=a.px.start&&f<=a.px.stop)return pxToIscnScale=(a.iscn.stop-a.iscn.start)/(a.px.stop-a.px.start),d=a.iscn.start+(f-a.px.start)*pxToIscnScale,bp=a.bp.start+(a.bp.stop-a.bp.start)*(d-a.iscn.start)/(a.iscn.stop-a.iscn.start),Math.round(bp);throw Error("Pixel out of range.  px: "+bp+"; length of chr"+c.name+": "+a.px.stop);};
Ideogram.prototype.drawSynteny=function(c){var f=(new Date).getTime(),d,a,b,k,h,g,e,l,m;h=d3.select("svg").append("g").attr("class","synteny");for(g=0;g<c.length;g++)regions=c[g],d=regions.r1,a=regions.r2,e="#CFC","color"in regions&&(e=regions.color),l=1,"opacity"in regions&&(l=regions.opacity),d.startPx=this.convertBpToPx(d.chr,d.start),d.stopPx=this.convertBpToPx(d.chr,d.stop),a.startPx=this.convertBpToPx(a.chr,a.start),a.stopPx=this.convertBpToPx(a.chr,a.stop),b=document.querySelectorAll("#"+d.chr.id+
" path")[0].getBBox(),k=document.querySelectorAll("#"+a.chr.id+" path")[0].getBBox(),b=b.y-30,k=k.y-29,m=d.chr.id+"_"+d.start+"_"+d.stop+"___"+a.chr.id+"_"+a.start+"_"+a.stop,syntenicRegion=h.append("g").attr("class","syntenicRegion").attr("id",m).on("click",function(){var b=this,a=d3.selectAll(".syntenicRegion").filter(function(a,c){return this!==b});a.classed("hidden",!a.classed("hidden"))}).on("mouseover",function(){var a=this;d3.selectAll(".syntenicRegion").filter(function(b,c){return this!==
a}).classed("ghost",!0)}).on("mouseout",function(){d3.selectAll(".syntenicRegion").classed("ghost",!1)}),syntenicRegion.append("polygon").attr("points",b+", "+d.startPx+" "+b+", "+d.stopPx+" "+k+", "+a.stopPx+" "+k+", "+a.startPx).attr("style","fill: "+e+"; fill-opacity: "+l),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",b).attr("x2",k).attr("y1",d.startPx).attr("y2",a.startPx),syntenicRegion.append("line").attr("class","syntenyBorder").attr("x1",b).attr("x2",k).attr("y1",
d.stopPx).attr("y2",a.stopPx);c=(new Date).getTime();this.debug&&console.log("Time in drawSyntenicRegions: "+(c-f)+" ms")};
Ideogram.prototype.processAnnotData=function(c){var f=c.keys;c=c.annots;var d,a,b,k,h,g,e;k=[];for(d=0;d<c.length;d++)for(annotsByChr=c[d],k.push({chr:annotsByChr.chr,annots:[]}),a=0;a<annotsByChr.annots.length;a++){h=annotsByChr.chr;ra=annotsByChr.annots[a];b={};for(e=0;e<f.length;e++)b[f[e]]=ra[e];b.stop=b.start+b.length;g=this.chromosomes["9606"][h];e=this.convertBpToPx(g,b.start);g=this.convertBpToPx(g,b.stop);e=Math.round((e+g)/2)-28;g=this.config.annotationsColor;this.config.annotationTracks?
(b.trackIndex=ra[3],g=this.config.annotationTracks[b.trackIndex].color):b.trackIndex=0;b.chr=h;b.chrIndex=d;b.px=e;b.color=g;k[d].annots.push(b)}return k};
Ideogram.prototype.getHistogramBars=function(c){var f=(new Date).getTime(),d,a,b,k,h,g,e,l,m,n,p=!1,q;l=[];g=this.config.barWidth;k=this.chromosomes[this.config.taxid];a=this.config.annotationsColor;q="histogramScaling"in this.config?this.config.histogramScaling:"relative";"undefined"===typeof this.maxAnnotsPerBar&&(this.maxAnnotsPerBar={},p=!0);for(b in k){chrModel=k[b];e=chrModel.chrIndex;lastBand=chrModel.bands[chrModel.bands.length-1];d=lastBand.px.stop;numBins=Math.round(d/g);m={chr:b,annots:[]};
for(d=0;d<numBins;d++)h=d*g-this.bump,bp=this.convertPxToBp(chrModel,h+this.bump),m.annots.push({bp:bp,px:h,count:0,chrIndex:e,chrName:b,color:a});l.push(m)}for(b in c)for(g=c[b].annots,d=c[b].chr,chrModel=k[d],e=chrModel.chrIndex,barAnnots=l[e-1].annots,d=0;d<g.length;d++)for(h=g[d],h=h.px,a=0;a<barAnnots.length-1;a++)if(m=barAnnots[a].px,n=barAnnots[a+1].px,h>m&&h<n){l[e-1].annots[a].count+=1;break}if(1==p||"relative"==q){for(d=k=0;d<l.length;d++)for(c=l[d].annots,a=0;a<c.length;a++)barCount=c[a].count,
barCount>k&&(k=barCount);this.maxAnnotsPerBar[b]=k}for(d=0;d<l.length;d++)for(c=l[d].annots,a=0;a<c.length;a++)barCount=c[a].count,height=barCount/this.maxAnnotsPerBar[b]*this.config.chrMargin,l[d].annots[a].height=height;c=(new Date).getTime();this.debug&&console.log("Time spent in getHistogramBars: "+(c-f)+" ms");return l};
Ideogram.prototype.drawAnnots=function(c){var f,d,a,b,k,h,g,e,l,m=this;f=this.config.chrMargin;d=this.config.chrWidth;a="tracks";this.config.annotationsLayout&&(a=this.config.annotationsLayout);"histogram"===a&&(c=m.getHistogramBars(c));b=this.config.annotationHeight;k="l -"+b+" "+2*b+" l "+2*b+" 0 z";c=d3.selectAll(".chromosome").data(c).selectAll("path.annot").data(function(a){return a.annots}).enter();"tracks"===a?c.append("g").attr("id",function(a,b){return a.id}).attr("class","annot").attr("transform",
function(a){return"translate("+a.px+","+((a.chrIndex+1)*f+d+a.trackIndex*b*2)+")"}).append("path").attr("d","m0,0"+k).attr("fill",function(a){return a.color}):"overlay"===a?c.append("polygon").attr("id",function(a,b){return a.id}).attr("class","annot").attr("points",function(a){h=a.px-.5;g=a.px+.5;e=(a.chrIndex+1)*f+d;l=(a.chrIndex+1)*f;return h+","+e+" "+g+","+e+" "+g+","+l+" "+h+","+l}).attr("fill",function(a){return a.color}):"histogram"===a&&c.append("polygon").attr("class","annot").attr("points",
function(a){h=a.px+m.bump;g=a.px+m.config.barWidth+m.bump;e=a.chrIndex*f+d;l=a.chrIndex*f+d+a.height;a=m.chromosomesArray[a.chrIndex-1].width;g>a&&(g=a);return h+","+e+" "+g+","+e+" "+g+","+l+" "+h+","+l}).attr("fill",function(a){return a.color});if(m.onDrawAnnotsCallback)m.onDrawAnnotsCallback()};
Ideogram.prototype.putChromosomesInRows=function(){var c=this.config.rows,f,d,a,b,k,h;f=Math.floor(this.numChromosomes/c);b=0;"g"!==d3.select("svg > *")[0][0].tagName&&(b=2);for(var g=1;g<c;g++)d=f*g+1+b,a=d+f,range="nth-child(n+"+d+"):nth-child(-n+"+a+")",k=this.config.chrHeight+20,d=d+1-b,a=this.config.chrWidth,h=this.config.chrMargin*d,this.config.showBandLabels||(d+=2),this.config.showChromosomeLabels&&(k+=12),rowWidth=h+(a-4)*d+8,d3.selectAll("#ideogram .chromosome:"+range).attr("transform",
function(a,b){return d3.select(this).attr("transform")+("translate("+k+", "+rowWidth+")")})};Ideogram.prototype.onBrushMove=function(){call(this.onBrushMoveCallback)};
Ideogram.prototype.createBrush=function(c,f){var d=this,a=d.config.chrWidth+6.5,b=d.chromosomesArray[0],k=b.bands[b.bands.length-1].bp.stop,h,g;g=[0];h=[0];for(var e,l=0;l<b.bands.length;l++)e=b.bands[l],g.push(e.bp.stop),h.push(e.px.stop);b=d3.scale.linear().domain(g).range(h);g=d3.select(".band")[0][0].getBBox().y-3.25;"undefined"===typeof c&&(c=Math.floor(k/10));"undefined"===typeof right&&(f=Math.ceil(2*c));k=c;h=f;d.selectedRegion={from:c,to:f,extent:f-c};d.brush=d3.svg.brush().x(b).extent([k,
h]).on("brush",function(){var a=d.brush.extent(),b=Math.floor(a[0]),a=Math.ceil(a[1]);d.selectedRegion={from:b,to:a,extent:a-b};if(d.onBrushMove)d.onBrushMoveCallback()});d3.select("#ideogram").append("g").attr("class","brush").attr("transform","translate(0, "+g+")").call(d.brush).selectAll("rect").attr("height",a)};Ideogram.prototype.onLoad=function(){call(this.onLoadCallback)};Ideogram.prototype.onDrawAnnots=function(){call(this.onDrawAnnotsCallback)};
Ideogram.prototype.getBandColorGradients=function(){var c,f,d="";c=[["gneg","#FFF","#FFF","#DDD"],["gpos25","#C8C8C8","#DDD","#BBB"],["gpos33","#BBB","#BBB","#AAA"],["gpos50","#999","#AAA","#888"],["gpos66","#888","#888","#666"],["gpos75","#777","#777","#444"],["gpos100","#444","#666","#000"],["acen","#FEE","#FEE","#FDD"]];for(var a=0;a<c.length;a++)f=c[a][0],color1=c[a][1],color2=c[a][2],color3=c[a][3],d+='<linearGradient id="'+f+'" x1="0%" y1="0%" x2="0%" y2="100%">',d="gneg"==f?d+('<stop offset="70%" stop-color="'+
color2+'" /><stop offset="95%" stop-color="'+color3+'" /><stop offset="100%" stop-color="'+color1+'" />'):d+('<stop offset="5%" stop-color="'+color1+'" /><stop offset="15%" stop-color="'+color2+'" /><stop offset="60%" stop-color="'+color3+'" />'),d+="</linearGradient>";css='<style>.gneg {fill: url("#gneg")} .gpos25 {fill: url("#gpos25")} .gpos33 {fill: url("#gpos33")} .gpos50 {fill: url("#gpos50")} .gpos66 {fill: url("#gpos66")} .gpos75 {fill: url("#gpos75")} .gpos100 {fill: url("#gpos100")} .acen {fill: url("#acen")} .stalk {fill: url("#stalk")} .gvar {fill: url("#gvar")} </style>';
return d=css+("<defs>"+(d+'<pattern id="stalk" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#CCE" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#88B; stroke-width:0.7;" /></pattern><pattern id="gvar" width="2" height="1" patternUnits="userSpaceOnUse" patternTransform="rotate(-30 0 0)"><rect x="0" y="0" width="10" height="2" fill="#DDF" /> <line x1="0" y1="0" x2="0" y2="100%" style="stroke:#99C; stroke-width:0.7;" /></pattern>')+
"</defs>")};
Ideogram.prototype.getTaxids=function(){var c,f,d,a,b,k,h,g;k="taxid"in this.config;this.config.multiorganism="organism"in this.config&&this.config.organism instanceof Array||k&&this.config.taxid instanceof Array;g=this.config.multiorganism;if("organism"in this.config){a=g?this.config.organism:[this.config.organism];f=[];h={};for(b=0;b<a.length;b++)for(c in d=a[b],this.organisms)this.organisms[c].commonName.toLowerCase()===d&&(f.push(c),g&&(h[c]=this.config.chromosomes[d]));this.config.taxids=f;g&&
(this.config.chromosomes=h)}g?(this.coordinateSystem="bp",k&&(f=this.config.taxid)):(k&&(f=[this.config.taxid]),this.config.taxids=f);return f};
Ideogram.prototype.initDrawChromosomes=function(c){var f=this.config.taxids,d=0,a,b,k,h,g;for(a=0;a<f.length;a++){taxid=f[a];k=this.config.chromosomes[taxid];this.chromosomes[taxid]={};for(b=0;b<k.length;b++)bands=c[d],d+=1,h=k[b],g=this.getChromosomeModel(bands,h,taxid,d),this.chromosomes[taxid][h]=g,this.chromosomesArray.push(g),this.drawChromosome(g,d);!0===this.config.showBandLabels&&this.drawBandLabels(this.chromosomes)}};
Ideogram.prototype.init=function(){function c(){e.config.annotationsPath&&d3.json(e.config.annotationsPath,function(a){e.rawAnnots=a});h="";e.config.showChromosomeLabels&&(h="horizontal"==e.config.orientation?h+"labeledLeft ":h+"labeled ");e.config.annotationsLayout&&"overlay"===e.config.annotationsLayout&&(h+="faint");var a;"vertical"===e.config.orientation?(a=e.config.chrHeight+30,1<e.config.rows&&(a=e.config.rows*(a-30))):a=e.config.chrMargin*e.numChromosomes+30;var b=e.getBandColorGradients();
d3.select(e.config.container).append("svg").attr("id","ideogram").attr("class",h).attr("width","97%").attr("height",a).html(b);d()}function f(){var a,b,c,d,f,g,h;m=[];if(!0===e.config.multiorganism)for(e.coordinateSystem="bp",f=e.config.taxids,k=0;k<f.length;k++);else"undefined"==typeof e.config.taxid&&(e.config.taxid=e.config.taxids[0]),a=e.config.taxid,f=[a],e.config.taxids=f;"chromosomes"in e.config&&(g=e.config.chromosomes);e.config.multiorganism&&(h=g);e.config.chromosomes={};var l=(new Date).getTime();
for(c=0;c<f.length;c++)for(a=f[c],d=e.bandData[a],e.config.multiorganism&&(g=h[a]),bandsByChr=e.getBands(d,a,g),g=Object.keys(bandsByChr),e.config.chromosomes[a]=g.slice(),e.numChromosomes+=e.config.chromosomes[a].length,d=0;d<g.length;d++)a=g[d],b=bandsByChr[a],m.push(b),a=b[b.length-1].iscn.stop,b=b[b.length-1].bp.stop,a>e.maxLength.iscn&&(e.maxLength.iscn=a),b>e.maxLength.bp&&(e.maxLength.bp=b);c=(new Date).getTime();e.debug&&console.log("Time in processBandData: "+(c-l)+" ms")}function d(){try{var c=
(new Date).getTime(),d=0,f,h,k;e.initDrawChromosomes(m);for(h=d=0;h<b.length;h++)for(a=b[h],g=e.config.chromosomes[a],k=0;k<g.length;k++)d+=1,chromosome=g[k],chrModel=e.chromosomes[a][chromosome],chr=d3.select("#chr"+chromosome+"-"+a),e.initTransformChromosome(chr,d);if(e.config.annotationsPath){var n=function(){"undefined"!==typeof timeout&&window.clearTimeout(timeout);e.annots=e.processAnnotData(e.rawAnnots);e.drawAnnots(e.annots);e.initCrossFilter&&e.initCrossFilter()};e.rawAnnots?n():function t(){timeout=
setTimeout(function(){e.rawAnnots?n():t()},50)}()}if(!0===e.config.showBandLabels){var p=e.bandsToShow.join(","),q=(new Date).getTime();d3.selectAll(".bandLabel, .bandLabelStalk").style("display","none");d3.selectAll(p).style("display","");var u=(new Date).getTime();e.debug&&console.log("Time in showing bands: "+(u-q)+" ms");if("vertical"===e.config.orientation)for(f=0;f<e.chromosomesArray.length;f++)e.rotateChromosomeLabels(d3.select("#"+e.chromosomesArray[f].id),f)}!0===e.config.showChromosomeLabels&&
e.drawChromosomeLabels(e.chromosomes);1<e.config.rows&&e.putChromosomesInRows();!0===e.config.brush&&e.createBrush();var v=(new Date).getTime();e.debug&&console.log("Time in drawChromosome: "+(v-c)+" ms");var w=(new Date).getTime();e.debug&&console.log("Time constructing ideogram: "+(w-l)+" ms");if(e.onLoadCallback)e.onLoadCallback()}catch(x){console.log(x.stack)}}var a,b,k,h,g,e=this,l=(new Date).getTime(),m=[],n=0,p=this.config.resolution,q;b=e.getTaxids();e.config.taxids=b;for(k=0;k<b.length;k++)a=
b[k],e.config.assembly||(e.config.assembly="default"),q=e.organisms[a].assemblies[e.config.assembly],bandDataFileNames={9606:"native/ideogram_9606_"+q+"_"+p+"_V1.js",10090:"native/ideogram_10090_"+q+"_NA_V2.js",7227:"ucsc/drosophila_melanogaster_dm6.tsv"},"undefined"===typeof chrBands?d3.xhr(e.config.bandDir+bandDataFileNames[a]).on("beforesend",function(b){b.taxid=a}).get(function(a,d){e.bandData[d.taxid]=d.response;n+=1;n==b.length&&(f(),c())}):(e.bandData[a]=chrBands,f(),c())};
//# sourceMappingURL=ideogram.js.map
